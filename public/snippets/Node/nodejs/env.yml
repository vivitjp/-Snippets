---
#-------------------------------
# env
#-------------------------------
- KEY: env.category
  CATEGORY: .env 環境設定

- KEY: env.環境設定
  EXPLAIN: 概要
  BODY: |
    ■ 概要

    環境変数を外部ファイル(.env)に定義し、コード内で参照する方法
    開発/本番など環境ごとに設定を切り替え可能
    セキュリティ: APIキーなどソースコードに含めたくない情報を分離可能
    注意: .env ファイルは .gitignore に記述して git にアップしないこと！

    ■ 代表的なパッケージ

    dotenv:                シンプルで広く使われている

      ※必要な理由: Node.js アプリケーションで環境変数を簡単に管理可能

    dotenv-webpack:        webpack 用プラグイン

      ※必要な理由: create-react-app や Vite などのフレームワークでは
        独自に環境変数の仕組みを持っているため、dotenv を直接使わない場合が多い

    react-dotenv:          React 専用

      ※必要な理由: create-react-app では dotenv を直接使わないため

    cross-env:             OS 間の互換性を考慮したい場合

      ※必要な理由: Windows と Unix 系(OSX, Linux)で環境変数の設定方法が異なるため

    ■ 開発環境ごとのファイル
    .env                    // 共通設定
    .env.local              // ローカル専用(.gitignore 推奨)
    .env.development        // 開発環境用
    .env.test               // テスト環境用
    .env.production         // 本番環境用

    ※ create-react-app や Vite などのフレームワークでサポート
    ※ nextjs では .env.local, .env.development.local, .env.test.local, .env.production.local もサポート
    ※ 優先順位: ローカル > 環境別 > 共通

- KEY: env.dotenv
  EXPLAIN: dotenv & cross-env
  BODY: |
    ■ dotenv インストール

      npm i dotenv

      create-react-app ではインストール済
      dotenv パッケージをインストール、ルートディレクトリに ".env" ファイル作成
      注意: .env ファイルは .gitignore に記述して git にアップしないこと！

    ■ 使い方（Node.js エントリで最初に読み込む）

      require('dotenv').config(); // または import 'dotenv/config'

      console.log(process.env.API_KEY);
      
    ■ .env ファイル記述例

      TEST_VALUE=PRODUCTION
      API_KEY=1234567890abcdef
      DB_HOST=localhost
      DB_USER=root  
      DB_PASS=s1mpl3

    ■ コード内での読み込み例

      require('dotenv').config();           // dotenv 読み込み
      console.log(process.env.TEST_VALUE);  // PRODUCTION
      console.log(process.env.API_KEY);     // 1234567890abcdef
      console.log(process.env.DB_HOST);     // localhost
      console.log(process.env.DB_USER);     // root

    ■ cross-env

      npm i -D cross-env

      cross-env パッケージをインストール
      OS 間の互換性を考慮して環境変数を設定可能にする

    ■ package.json スクリプト例

      "scripts": {
        "start": "cross-env NODE_ENV=development node app.js",
        "build": "cross-env NODE_ENV=production webpack --config webpack.config.js"
      }

- KEY: env.dotenv.フレームワーク
  EXPLAIN: フレームワーク と ライブラリ
  BODY: |
    ■ Vite

      ビルド時にクライアントへ露出させたい変数は VITE_ プレフィックスが必要（VITE_API_URL）
      参照: import.meta.env.VITE_API_URL

    ■ Next.js

      NEXT_PUBLIC_ プレフィックスでクライアント公開、ビルド時に取り込まれる
      参照: process.env.NEXT_PUBLIC_API_URL

    ■ Create React App

      REACT_APP_ プレフィックスでクライアント公開
      参照: process.env.REACT_APP_API_URL

    ■ ライブラリで厳格にする（推奨）
      
      envalid, env-schema, zod, joi などでスキーマを定義して検証

      const { cleanEnv, port } = require('envalid');
      const env = cleanEnv(process.env, {
        NODE_ENV: str({ choices: ['development','production','test'] }),
        PORT: port({ default: 3000 }),
        DATABASE_URL: str(),
      });

- KEY: env.format.デプロイ
  EXPLAIN: デプロイ/CI の例(GitHub)
  BODY: |
    GitHub Actions: secrets に登録し、ワークフローで env: に渡す

    ■ 例1
    jobs:
      build:
        runs-on: ubuntu-latest
        env:
          API_KEY: ${{ secrets.API_KEY }}  // ジョブ全体で利用可能
          DB_HOST: ${{ secrets.DB_HOST }}
        steps:
          - name: Checkout code
            uses: actions/checkout@v2
          - name: Build project
            run: npm run build

      長所：同じ環境変数を複数ステップで使うときに便利で冗長性を減らす。見通しが良い。
      短所：ジョブ内のすべてのステップがその値にアクセスできる → 必要以上に権限を広げる可能性。

    ■ 例2
    jobs:
      deploy:
        runs-on: ubuntu-latest
        steps:
          - name: Deploy
            env:
              API_KEY: ${{ secrets.API_KEY }}  // このステップだけで利用可能
            run: npm run build

      長所：最小権限の原則に沿う（そのステップだけが値を使える）。セキュリティ的に安全。
      短所：複数ステップで同じ値を使うなら冗長になりやすい。

- KEY: env.format
  EXPLAIN: 書式フォーマット
  BODY: |
    ■ 空行は無視

      # コメント

    ■ 値が空白含む

      KEY1=AAA BBB CCC                  // { KEY1: 'AAA BBB CCC' }
      KEY1='AAA BBB CCC'                // { KEY1: 'AAA BBB CCC' }
      KEY1="AAA BBB CCC"                // { KEY1: 'AAA BBB CCC' }

    ■ 値の省略(空文字処理)

      EY1=                              // { KEY1: '' }

    ■ キー/値の前後はトリム

      KEY1= AAA                         // { KEY1: 'AAA' }

    ■ コード内からの参照

    console.log(process.env.KEY1);      // VALUE1

    ■ 存在エラー判定
    if (typeof process.env.KEY1 == 'undefined') {
      console.error('Error: "KEY1" is not set.');
      console.error('Please consider adding a .env file with KEY1.');
      process.exit(1);
    }
    console.log(process.env.KEY1);                // VALUE1

- KEY: env.Nodejsの環境変数
  EXPLAIN: Nodejsの環境変数
  BODY: |
    ■ 実行環境を指定（慣例）

      NODE_ENV=production
      // package.json の scripts 例
      "build": "cross-env NODE_ENV=production npm run build"

    ■ Node 起動オプションを一括で指定

      NODE_OPTIONS="--max-old-space-size=4096 --inspect=0.0.0.0:9229"

    ■ モジュール探索パスを追加（非推奨気味）

      NODE_PATH=./src

    ■ コアモジュールのデバッグ出力制御

      NODE_DEBUG=http,fs

    ■ 警告抑制（1 で抑制）

      NODE_NO_WARNINGS=1

    ■ V8 カバレッジ出力先を指定

      NODE_V8_COVERAGE=./.coverage

    ■ libuv スレッドプールサイズ（デフォルト 4）

      UV_THREADPOOL_SIZE=8

    ■ debug ライブラリ用のログフィルタ

      DEBUG=myapp:*   # 例: myapp:server,myapp:db のみ出力

    ■ カラー出力の強制/無効化

      FORCE_COLOR=1
      NO_COLOR=1

    ■ TLS 証明書検証（0=無効）

      NODE_TLS_REJECT_UNAUTHORIZED=0   # 危険: 本番では使用しない

    ■ 追加の CA 証明書ファイル

      NODE_EXTRA_CA_CERTS=./certs/ca.pem

    ■ アプリのバインド先（多くのサーバで参照）

      PORT=3000
      HOST=0.0.0.0

    ■ 接続文字列（アプリ固有）

      DATABASE_URL=postgres://user:pass@db.example.com:5432/dbname
      REDIS_URL=redis://:password@redis.example.com:6379

    ■ シークレット（.env / CI secrets で管理）

      API_KEY=abcd1234
      SECRET_KEY=xxxxxxxxxxxxxxxx

    ■ npm 関連（npm 実行時に自動注入される変数）

      npm_config_registry=https://registry.npmjs.org/
      npm_package_name=my-package

    ■ OS共通（PATH, HOME 等）

      PATH=/usr/local/bin;C:\Windows\System32
      HOME=/home/user    # Windows: USERPROFILE=C:\Users\User

    ■ 使い方の注意

    ・機密情報は `.env` としてリポジトリに含めない（`.gitignore` に追加）
    ・CI では `secrets` を使い、必要最小限のスコープで渡す（ジョブ or ステップ単位）
    ・`NODE_OPTIONS` や `NODE_TLS_REJECT_UNAUTHORIZED=0` は誤用すると危険
    ・フロント向けに公開する変数は Vite の `VITE_` や CRA の `REACT_APP_` 等のプレフィックスを使う
