---
#-------------------------------
# tRPC
#-------------------------------
- ENTRY:
  EXPLAIN: æ¦‚è¦
  BODY: |
    â–  tRPC (TypeScript Remote Procedure Call) ã¨ã¯

    ãƒ»TypeScript ã‚’æ´»ç”¨ã—ãŸå‹å®‰å…¨ãª API æ§‹ç¯‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    ãƒ»ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã§å‹å®šç¾©ã‚’å…±æœ‰ã—ã€API å‘¼ã³å‡ºã—ã‚’å®Œå…¨ã«å‹å®‰å…¨ã«ã™ã‚‹
    ãƒ»REST API ã‚„ GraphQL ã¨ã¯ç•°ãªã‚Šã€RPC (Remote Procedure Call) ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ¡ç”¨
    ãƒ»ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é–¢æ•°ã¨ã—ã¦å®šç¾©ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã™ã‚¤ãƒ¡ãƒ¼ã‚¸

    â–  ä¸»ãªç‰¹å¾´

    ãƒ»å®Œå…¨ãªå‹å®‰å…¨: TypeScript ã®å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ´»ç”¨ã—ã€API ã®å…¥å‡ºåŠ›ãŒå³å¯†ã«å‹ä»˜ã‘ã•ã‚Œã‚‹
    ãƒ»è‡ªå‹•ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ: API å®šç¾©ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹
    ãƒ»è»½é‡: è¿½åŠ ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¦
    ãƒ»æŸ”è»Ÿæ€§: HTTP/WS ãªã©æ§˜ã€…ãªãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆå±¤ã«å¯¾å¿œ
    ãƒ»é–‹ç™ºä½“é¨“ã®å‘ä¸Š: ã‚¤ãƒ³ãƒ†ãƒªã‚»ãƒ³ã‚¹ã«ã‚ˆã‚‹è£œå®Œã€ã‚¨ãƒ©ãƒ¼ã®æ—©æœŸç™ºè¦‹

    â–  ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

    ãƒ»ãƒ¢ãƒãƒªã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® API å±¤
    ãƒ»ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é€šä¿¡
    ãƒ»ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ TypeScript ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ (WebSocket å¯¾å¿œ)

    â–  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

    ãƒ»Server: API ãƒ«ãƒ¼ã‚¿ãƒ¼ã¨ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’å®šç¾©
    ãƒ»Client: ã‚µãƒ¼ãƒãƒ¼å®šç¾©ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸå‹ä»˜ãã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨
    ãƒ»Protocol: JSON-RPC 2.0 ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«

- ENTRY:
  EXPLAIN: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  BODY: |
    â–  åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

    npm install @trpc/server @trpc/client @trpc/react @trpc/next

    â–  ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ

    ãƒ»@trpc/server: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…
    ãƒ»@trpc/client: æ±ç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    ãƒ»@trpc/react: React å‘ã‘ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (React Query çµ±åˆ)
    ãƒ»@trpc/next: Next.js å‘ã‘çµ±åˆ

    â–  è¿½åŠ æ¨å¥¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

    npm install @tanstack/react-query # React Query (ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°)
    npm install zod # å…¥åŠ›æ¤œè¨¼
    npm install superjson # é«˜åº¦ãª JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

- ENTRY:
  EXPLAIN: æ³¨æ„ç‚¹
  BODY: |
    â–  TypeScript å¿…é ˆ

    ãƒ»tRPC ã¯ TypeScript ã®å‹ã‚·ã‚¹ãƒ†ãƒ ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€.ts/.tsx ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ä½¿ç”¨ãŒå‰æ
    ãƒ»JavaScript ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ä½¿ç”¨ä¸å¯

    â–  ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›æ€§

    ãƒ»@trpc/* ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯æƒãˆã‚‹ã“ã¨ã‚’æ¨å¥¨

    â–  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®

    ãƒ»å¤§è¦æ¨¡ API ã®å ´åˆã€ãƒ«ãƒ¼ã‚¿ãƒ¼ã®åˆ†å‰²ã‚’æ¤œè¨
    ãƒ»ãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’å‰Šæ¸›

    â–  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

    ãƒ»å…¥åŠ›æ¤œè¨¼ã‚’å¿…ãšå®Ÿè£… (Zod æ¨å¥¨)
    ãƒ»èªè¨¼/èªå¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ä½¿ç”¨ã‚’æ¤œè¨
    ãƒ»CORS è¨­å®šã«æ³¨æ„

- ENTRY:
  CATEGORY: Server

- ENTRY:
  EXPLAIN: åŸºæœ¬è¨­å®š (Node.js + Express)
  BODY: |
    â–  ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

    src/
    â”œâ”€â”€ server.ts         # Express ã‚µãƒ¼ãƒãƒ¼è¨­å®š
    â”œâ”€â”€ trpc.ts           # tRPC åˆæœŸåŒ–
    â”œâ”€â”€ routers/
    â”‚   â”œâ”€â”€ index.ts      # ãƒ«ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¸
    â”‚   â”œâ”€â”€ user.ts       # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ«ãƒ¼ã‚¿ãƒ¼
    â”‚   â””â”€â”€ post.ts       # ãƒã‚¹ãƒˆãƒ«ãƒ¼ã‚¿ãƒ¼
    â””â”€â”€ types.ts          # å…±æœ‰å‹å®šç¾©

    â–  ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

    npm install express cors @types/express @types/cors

    â–  tRPC åˆæœŸåŒ– (trpc.ts)

    import { initTRPC } from '@trpc/server';
    import superjson from 'superjson';

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå‹å®šç¾©
    export interface Context {
      user?: {
        id: string;
        name: string;
      };
    }

    // tRPC ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
    const t = initTRPC.context<Context>().create({
      transformer: superjson, // é«˜åº¦ãª JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º
      errorFormatter({ shape, error }) {
        return {
          ...shape,
          data: {
            ...shape.data,
            zodError: error.cause instanceof ZodError ? error.cause.flatten() : null,
          },
        };
      },
    });

    export const router = t.router;
    export const publicProcedure = t.procedure;

    â–  Express ã‚µãƒ¼ãƒãƒ¼è¨­å®š (server.ts)

    import express from 'express';
    import cors from 'cors';
    import { createExpressMiddleware } from '@trpc/server/adapters/express';
    import { appRouter } from './routers';
    import { createContext } from './context';

    const app = express();

    // CORS è¨­å®š
    app.use(cors({
      origin: process.env.CLIENT_URL || 'http://localhost:3000',
      credentials: true,
    }));

    // JSON ãƒ‘ãƒ¼ã‚¹
    app.use(express.json());

    // tRPC ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
    app.use(
      '/trpc',
      createExpressMiddleware({
        router: appRouter,
        createContext,
      }),
    );

    const PORT = process.env.PORT || 4000;
    app.listen(PORT, () => {
      console.log(`Server running on http://localhost:${PORT}`);
    });

    â–  ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ (context.ts)

    import type { CreateExpressContextOptions } from '@trpc/server/adapters/express';

    export async function createContext({ req, res }: CreateExpressContextOptions) {
      // JWT ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
      const token = req.headers.authorization?.split(' ')[1];
      let user = undefined;

      if (token) {
        try {
          // JWT æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
          user = { id: '1', name: 'John Doe' }; // ä»®å®Ÿè£…
        } catch (error) {
          // ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
        }
      }

      return {
        user,
        req,
        res,
      };
    }

- ENTRY:
  EXPLAIN: ãƒ«ãƒ¼ã‚¿ãƒ¼å®šç¾©
  BODY: |
    â–  åŸºæœ¬çš„ãªãƒ«ãƒ¼ã‚¿ãƒ¼æ§‹é€ 

    import { router, publicProcedure } from '../trpc';
    import { z } from 'zod';

    // å…¥åŠ›æ¤œè¨¼ã‚¹ã‚­ãƒ¼ãƒ
    const userSchema = z.object({
      name: z.string().min(1),
      email: z.string().email(),
    });

    export const userRouter = router({
      // ã‚¯ã‚¨ãƒª: ãƒ‡ãƒ¼ã‚¿å–å¾—
      getUser: publicProcedure
        .input(z.object({ id: z.string() }))
        .query(async ({ input, ctx }) => {
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
          return { id: input.id, name: 'John', email: 'john@example.com' };
        }),

      // ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ‡ãƒ¼ã‚¿å¤‰æ›´
      createUser: publicProcedure
        .input(userSchema)
        .mutation(async ({ input, ctx }) => {
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
          const user = { id: '1', ...input };
          return user;
        }),

      // ãƒªã‚¹ãƒˆå–å¾—
      listUsers: publicProcedure
        .query(async () => {
          return [
            { id: '1', name: 'John', email: 'john@example.com' },
            { id: '2', name: 'Jane', email: 'jane@example.com' },
          ];
        }),
    });

    â–  ãƒ«ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ã‚¸ (routers/index.ts)

    import { router } from '../trpc';
    import { userRouter } from './user';
    import { postRouter } from './post';

    export const appRouter = router({
      user: userRouter,
      post: postRouter,
    });

    // å‹ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ä½¿ç”¨)
    export type AppRouter = typeof appRouter;

- ENTRY:
  EXPLAIN: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨èªè¨¼
  BODY: |
    â–  èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

    import { TRPCError } from '@trpc/server';
    import { t } from '../trpc';

    // èªè¨¼æ¸ˆã¿ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ¼
    export const protectedProcedure = t.procedure.use(async ({ ctx, next }) => {
      if (!ctx.user) {
        throw new TRPCError({
          code: 'UNAUTHORIZED',
          message: 'èªè¨¼ãŒå¿…è¦ã§ã™',
        });
      }

      return next({
        ctx: {
          ...ctx,
          user: ctx.user, // å‹å®‰å…¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±åˆ©ç”¨å¯èƒ½
        },
      });
    });

    â–  ä½¿ç”¨ä¾‹

    export const protectedRouter = router({
      getSecretData: protectedProcedure
        .query(async ({ ctx }) => {
          // ctx.user ãŒç¢ºå®Ÿã«å­˜åœ¨
          return { secret: 'æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿', userId: ctx.user.id };
        }),
    });

    â–  ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹èªå¯

    export const adminProcedure = protectedProcedure.use(async ({ ctx, next }) => {
      if (ctx.user.role !== 'admin') {
        throw new TRPCError({
          code: 'FORBIDDEN',
          message: 'ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™',
        });
      }

      return next();
    });

- ENTRY:
  EXPLAIN: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  BODY: |
    â–  TRPCError ã®ä½¿ç”¨

    import { TRPCError } from '@trpc/server';

    // æ§˜ã€…ãªã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
    throw new TRPCError({
      code: 'BAD_REQUEST',      // 400
      message: 'ç„¡åŠ¹ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ',
    });

    throw new TRPCError({
      code: 'UNAUTHORIZED',     // 401
      message: 'èªè¨¼ãŒå¿…è¦ã§ã™',
    });

    throw new TRPCError({
      code: 'FORBIDDEN',        // 403
      message: 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“',
    });

    throw new TRPCError({
      code: 'NOT_FOUND',        // 404
      message: 'ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
    });

    throw new TRPCError({
      code: 'INTERNAL_SERVER_ERROR', // 500
      message: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼',
    });

    â–  Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼

    // ã‚¨ãƒ©ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã§è‡ªå‹•å‡¦ç†
    errorFormatter({ shape, error }) {
      return {
        ...shape,
        data: {
          ...shape.data,
          zodError: error.cause instanceof ZodError ? error.cause.flatten() : null,
        },
      };
    }

- ENTRY:
  CATEGORY: Client

- ENTRY:
  EXPLAIN: React ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
  BODY: |
    â–  ä¾å­˜é–¢ä¿‚

    npm install @tanstack/react-query @trpc/client @trpc/react

    â–  tRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ (client.ts)

    import { createTRPCReact } from '@trpc/react-query';
    import type { AppRouter } from '../server/routers';  // ğŸ”µé‡è¦ãƒã‚¤ãƒ³ãƒˆ

    export const trpc = createTRPCReact<AppRouter>();

    â–  React Query è¨­å®š (App.tsx)

    import React from 'react';
    import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
    import { httpBatchLink } from '@trpc/client';
    import { trpc } from './client';

    const queryClient = new QueryClient({
      defaultOptions: {
        queries: {
          retry: 3,
          staleTime: 1000 * 60 * 5, // 5åˆ†
        },
      },
    });

    const trpcClient = trpc.createClient({
      links: [
        httpBatchLink({
          url: 'http://localhost:4000/trpc',
          // èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼
          headers() {
            return {
              authorization: `Bearer ${localStorage.getItem('token')}`,
            };
          },
        }),
      ],
    });

    function App() {
      return (
        <trpc.Provider client={trpcClient} queryClient={queryClient}>
          <QueryClientProvider client={queryClient}>
            <MyApp />
          </QueryClientProvider>
        </trpc.Provider>
      );
    }

- ENTRY:
  EXPLAIN: AppRouter å‹ã®åŒæœŸæ–¹æ³•
  BODY: |
    â–  åŒä¸€ãƒªãƒã‚¸ãƒˆãƒªï¼ˆmonorepo/åŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰

    ãƒ»ã‚µãƒ¼ãƒå´ã§å‹ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼š
      // server/routers/index.ts
      export const appRouter = router({ /* ... */ });
      export type AppRouter = typeof appRouter;

    ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å‹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼š
      // client/trpc.ts
      import type { AppRouter } from '../server/routers';
      export const trpc = createTRPCReact<AppRouter>();

    ãƒ»è£œè¶³ï¼šå¿…ãš import type ã‚’ä½¿ã†ï¼ˆãƒ“ãƒ«ãƒ‰ã§å‹ã®ã¿å‚ç…§ã•ã‚Œã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã‚µãƒ¼ãƒã‚³ãƒ¼ãƒ‰ãŒå–ã‚Šè¾¼ã¾ã‚Œãªã„ï¼‰

    â–  åˆ¥ãƒªãƒã‚¸ãƒˆãƒªï¼åˆ¥ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆæ¨å¥¨ï¼šå…±æœ‰ types ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰

    ãƒ»ã‚µãƒ¼ãƒã® AppRouter å‹ã ã‘ã‚’åˆ‡ã‚Šå‡ºã—ã¦ @org/trpc-types ã®ã‚ˆã†ãª package ã«ã™ã‚‹
        monorepo ã® packages/shared-types ãªã©

    ãƒ»package.json ã« types ã‚’å«ã‚ã¦ .d.ts ã‚’å…¬é–‹ï¼ˆã¾ãŸã¯ tsc ã§å‹å®šç¾©ã‚’å‡ºåŠ›ï¼‰

    ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§é€šå¸¸ã® npm ä¾å­˜ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å‹ã‚’ import
        import type { AppRouter } from "@org/trpc-types";
        const trpc = createTRPCReact<AppRouter>();

    ãƒ»é…å¸ƒæ–¹æ³•ï¼šnpmï¼ˆå…¬é–‹/ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆï¼‰ã€git URLã€npm scopeã€ã¾ãŸã¯ workspace

    â–  åˆ¥æ¡ˆï¼ˆè»½é‡ï¼‰

    ãƒ»API ã‚¹ã‚­ãƒ¼ãƒã¨å‹ã‚’åˆ¥ãƒªãƒã‚¸ãƒˆãƒªã« JSON/TS ã§ä¿æŒã—ã¦ä¸¡æ–¹ã‹ã‚‰å‚ç…§
    ãƒ»ã‚ã‚‹ã„ã¯ Zod ã‚’å…±æœ‰ã—ã¦å‹ã‚’ä¸¡æ–¹ã§å†åˆ©ç”¨ï¼ˆãŸã ã—å‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ãã¡ã‚“ã¨æƒãˆã‚‹å¿…è¦ã‚ã‚Šï¼‰

    â–  é‡è¦ãªæ³¨æ„ç‚¹

    ãƒ»ã€Œå‹ã ã‘ã€ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ï¼šçµ¶å¯¾ã«ã‚µãƒ¼ãƒã®å®Ÿè¡Œã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒãƒ³ãƒ‰ãƒ«ã—ãªã„
      å‹ã ã‘ãªã‚‰ import type ã§å®‰å…¨

    ãƒ»ç›¸å¯¾ãƒ‘ã‚¹ã§ç›´æ¥ã‚µãƒ¼ãƒã®å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹ã¨ã€ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã«ã‚ˆã£ã¦ã¯å®Ÿè¡Œæ™‚ä¾å­˜ã‚’å¼•ãè¾¼ã‚€å¯èƒ½æ€§ã‚ã‚Š
      å…±æœ‰ç”¨ã®å‹ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆï¼ˆtypes-only package / index.d.tsï¼‰ã‚’ä½œã‚‹ã®ãŒå®‰å…¨

    ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼štRPC ã®å‹ã¯ã‚µãƒ¼ãƒã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§æ•´åˆæ€§ãŒå¿…è¦
      shared package ã‚’å°å…¥ã™ã‚‹ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãŒæ¥½

    ãƒ»Next.js / Vite ç­‰ã®ç’°å¢ƒã§ã¯ tsconfig ã® paths ã§ã‚‚å‚ç…§å¯èƒ½ï¼ˆmonorepo æ™‚ã«ä¾¿åˆ©ï¼‰

    â–  çŸ­ã„æ¨å¥¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆmonorepoï¼‰

    ãƒ»packages/
        server/ (appRouter ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ)
        web/ (frontend)
        shared-types/ (optional: å‹ã®ã¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ)

    ãƒ»server: export type AppRouter = typeof appRouter

    ãƒ»web: import type { AppRouter } from "shared-types"
      ã¾ãŸã¯ "../server/routers"ï¼ˆå‹å°‚ç”¨ã‚¨ãƒ³ãƒˆãƒªæ¨å¥¨ï¼‰

- ENTRY:
  EXPLAIN: ã‚¯ã‚¨ãƒªã¨ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
  BODY: |
    â–  ã‚¯ã‚¨ãƒªã®ä½¿ç”¨

    import { trpc } from '../client';

    function UserList() {
      const { data, isLoading, error } = trpc.user.listUsers.useQuery();

      if (isLoading) return <div>Loading...</div>;
      if (error) return <div>Error: {error.message}</div>;

      return (
        <ul>
          {data?.map(user => (
            <li key={user.id}>{user.name} - {user.email}</li>
          ))}
        </ul>
      );
    }

    â–  ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨

    function CreateUserForm() {
      const createUser = trpc.user.createUser.useMutation();
      const queryClient = useQueryClient();

      const handleSubmit = async (formData: { name: string; email: string }) => {
        try {
          await createUser.mutateAsync(formData);
          // æˆåŠŸæ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
          queryClient.invalidateQueries(['user.listUsers']);
        } catch (error) {
          console.error('ä½œæˆå¤±æ•—:', error);
        }
      };

      return (
        <form onSubmit={handleSubmit}>
          {/* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */}
        </form>
      );
    }

    â–  æ¥½è¦³çš„æ›´æ–°

    const createUser = trpc.user.createUser.useMutation({
      onMutate: async (newUser) => {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¥½è¦³çš„ã«æ›´æ–°
        await queryClient.cancelQueries(['user.listUsers']);
        const previousUsers = queryClient.getQueryData(['user.listUsers']);

        queryClient.setQueryData(['user.listUsers'], (old: any) => [
          ...old,
          { id: 'temp', ...newUser },
        ]);

        return { previousUsers };
      },
      onError: (err, newUser, context) => {
        // ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
        queryClient.setQueryData(['user.listUsers'], context?.previousUsers);
      },
      onSettled: () => {
        queryClient.invalidateQueries(['user.listUsers']);
      },
    });

- ENTRY:
  EXPLAIN: ãã®ä»–ã®æ§‹æˆã‚ªãƒ—ã‚·ãƒ§ãƒ³
  BODY: |
    â–  ãƒãƒƒãƒãƒ³ã‚°

    // è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’1ã¤ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¾ã¨ã‚ã‚‹
    httpBatchLink({
      url: 'http://localhost:4000/trpc',
      maxURLLength: 2083, // URLé•·åˆ¶é™
    });

    â–  WebSocket ã‚µãƒãƒ¼ãƒˆ

    npm install @trpc/server ws @types/ws

    import { applyWSSHandler } from '@trpc/server/adapters/ws';
    import ws from 'ws';

    const wss = new ws.Server({ port: 3001 });
    const handler = applyWSSHandler({ wss, router: appRouter, createContext });

    â–  ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

    // ã‚µãƒ¼ãƒãƒ¼å´
    streamingProcedure: publicProcedure
      .input(z.object({ message: z.string() }))
      .subscription(async function* ({ input }) {
        for (let i = 0; i < 10; i++) {
          yield { message: `${input.message} ${i}` };
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }),

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
    const subscription = trpc.streamingProcedure.subscribe(
      { message: 'Hello' },
      {
        onData: (data) => console.log(data),
        onError: (error) => console.error(error),
      }
    );

    â–  ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯

    import { createTRPCClient, httpLink } from '@trpc/client';

    const customLink = httpLink({
      url: 'http://localhost:4000/trpc',
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚§ãƒƒãƒé–¢æ•°
      fetch: (url, options) => {
        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰å‡¦ç†
        console.log('Sending request to:', url);
        return fetch(url, {
          ...options,
          headers: {
            ...options.headers,
            'X-Custom-Header': 'value',
          },
        });
      },
    });

    â–  ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š

    const queryClient = new QueryClient({
      defaultOptions: {
        queries: {
          staleTime: 1000 * 60 * 5, // 5åˆ†
          gcTime: 1000 * 60 * 10,   // 10åˆ† (ä»¥å‰ã® cacheTime)
          retry: (failureCount, error) => {
            // ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
            if (error instanceof TRPCError && error.code === 'UNAUTHORIZED') {
              return false; // èªè¨¼ã‚¨ãƒ©ãƒ¼ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
            }
            return failureCount < 3;
          },
        },
        mutations: {
          retry: false, // ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
        },
      },
    });

    â–  å‹å®‰å…¨ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

    type RouterError = TRPCClientError<AppRouter>;

    try {
      await trpc.user.createUser.mutateAsync(userData);
    } catch (error) {
      if (error instanceof TRPCClientError) {
        // å‹å®‰å…¨ãªã‚¨ãƒ©ãƒ¼å‡¦ç†
        if (error.data?.zodError) {
          // Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
          console.log(error.data.zodError);
        }
      }
    }

- ENTRY:
  EXPLAIN: ãƒ‡ãƒ—ãƒ­ã‚¤ã¨é‹ç”¨
  BODY: |
    â–  ç’°å¢ƒå¤‰æ•°

    .env
    DATABASE_URL=postgresql://...
    JWT_SECRET=your-secret-key
    CLIENT_URL=http://localhost:3000
    PORT=4000

    â–  Docker åŒ–

    Dockerfile
    FROM node:18-alpine
    WORKDIR /app
    COPY package*.json ./
    RUN npm ci --only=production
    COPY . .
    RUN npm run build
    EXPOSE 4000
    CMD ["npm", "start"]

    â–  ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    app.get('/health', (req, res) => {
      res.status(200).json({ status: 'ok' });
    });

    â–  ãƒ­ã‚°ã¨ç›£è¦–

    import pino from 'pino';
    const logger = pino();

    // ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ãƒ­ã‚°
    app.use((req, res, next) => {
      logger.info(`${req.method} ${req.url}`);
      next();
    });

    â–  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

    ãƒ»ãƒãƒƒãƒãƒ³ã‚°æœ‰åŠ¹åŒ–
    ãƒ»é©åˆ‡ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
    ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒªãƒ³ã‚°
    ãƒ»gzip åœ§ç¸®æœ‰åŠ¹åŒ–

    app.use(compression());
