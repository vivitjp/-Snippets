---
#-------------------------------
# Nestjs
#-------------------------------

- KEY: nest.install
  EXPLAIN: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  BODY: |
    npm i -g @nestjs/cli
    yarn global add @nestjs/cli

    â–  dependencies
    @nestjs/common
    @nestjs/core
    @nestjs/platform-express

    â–  devDependencies
    @nestjs/cli
    @nestjs/schematics
    @nestjs/testing

- KEY: nest.new.project
  EXPLAIN: Projectä½œæˆ
  BODY: |
    nest new my-app                               // DIRæŒ‡å®š
    nest new .                                    // ã‚«ãƒ¬ãƒ³ãƒˆDIR

    â–  Windows: path å•é¡Œ
    npx @nestjs/cli new my-app                    // npx ä½¿ç”¨

    Which package manager would you â¤ï¸  to use? yarn
    â–¹â–¸â–¹â–¹â–¹ Installation in progress... â˜•
    Failed to execute command: yarn install --silent
    âœ– Installation in progress... â˜•
    {
      "name": "@nestjs",  // <-----ä¿®æ­£: @ å‰Šé™¤ å†åº¦ã€yarn
      "version": "0.0.1",

    npx @nestjs --version
    8.3.0

- KEY: nest.files
  EXPLAIN: æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«
  BODY: |
    â–  ä¸»ãªæ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«
    nest-cli.json
    src/app.controller.ts
    src/app.module.ts
    src/app.service.ts
    src/main.ts

    â–  ä¸»ãªãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
    src/app.controller.spec.ts
    src/app.module.spec.ts
    src/app.service.spec.ts
    test/app.e2e-spec.ts
    test/jest-e2e.json

- KEY: nest.cli.command
  EXPLAIN: CLI ã‚³ãƒãƒ³ãƒ‰
  BODY: |
    â–  Moduleä½œæˆ
    npx nest g module <SUB_MODULE>                //g===generate

    â–  Controllerä½œæˆ
    npx nest g controller <SUB_MODULE> --no-spec  //no test

    â–  serviceä½œæˆ
    npx nest g service <SUB_MODULE> --no-spec

    â–  resolverä½œæˆ(graphQL)
    npx nest g resolver tasks <SUB_MODULE> --no-spec

- KEY: nest.start
  EXPLAIN: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
  BODY: |
    â–  èµ·å‹•
    $ npm run start                               // development
    $ npm run start:dev                           // watch
    $ npm run start:prod                          // production

    â–  ã‚¢ã‚¯ã‚»ã‚¹
    localhost:3000

    â–  Unit Tests
    $ npm run test
    $ npm run test:e2e
    $ npm run test:cov                            // coverage

- KEY: nest.settings
  EXPLAIN: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
  BODY: |
    â–  nest-cli.json
    {
      "$schema": "https://json.schemastore.org/nest-cli",
      "collection": "@nestjs/schematics",
      "sourceRoot": "src"
    }

- KEY: nest.dir.root
  EXPLAIN: ãƒ«ãƒ¼ãƒˆ(bootstrap)
  BODY: |
    import { NestFactory } from '@nestjs/core';
    import { AppModule } from './app.module';

    async function bootstrap(){
      //ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹
      const app = await NestFactory.create(AppModule);
      //èµ·å‹•ãƒãƒ¼ãƒˆ
      await app.listen(3000);
    }
    bootstrap();

- KEY: nest.dir.service
  EXPLAIN: 1.ã‚µãƒ¼ãƒ“ã‚¹(AppService)
  BODY: |
    import { Injectable } from '@nestjs/common';

    @Injectable()
    export class AppService {
      getHello(): string {
        return 'Hello World!';
      }
    }

- KEY: nest.dir.control
  EXPLAIN: 2.ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«(AppController)
  BODY: |
    import { Controller, Get } from '@nestjs/common';
    import { AppService } from './app.service';

    @Controller()
    export class AppController {
      // service.tsã§å®£è¨€ã—ãŸã‚¯ãƒ©ã‚¹ã‚’DI
      constructor(private readonly appService: AppService){}

      @Get()
      getHello(): string {
        return this.appService.getHello();
      }
    }

- KEY: nest.dir.module
  EXPLAIN: 3.ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«(AppModule)
  BODY: |
    import { Module } from '@nestjs/common';
    import { AppController } from './app.controller';
    import { AppService } from './app.service';
    import { TasksModule } from './tasks/tasks.module'; // ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ 

    @Module({
      imports: [TasksModule],                      // ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ 
      controllers: [AppController],
      providers: [AppService],
    })
    export class AppModule {}

- KEY: nest.sample.main
  EXPLAIN: main.ts
  BODY: |
    import { NestFactory } from '@nestjs/core';
    import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
    import { initializeTransactionalContext } from 'typeorm-transactional';
    import { AppModule } from './app.module';
    import { HttpExceptionFilter } from './app/filters/http-exception.filter';
    import { LoggingInterceptor } from './app/aspect/logging.interceptor';
    import * as cookieParser from 'cookie-parser';
    import * as requestContext from 'request-context';
    import { MIDDLEWARE_NAME_SPACE } from './app/log/base-logger.log';
    import { writeFileSync } from 'fs';
    import { dump } from 'js-yaml';

    async function bootstrap(){
      initializeTransactionalContext();
      const app = await NestFactory.create(AppModule, {
        cors: {
          // è¨±å¯ã‚ªãƒªã‚¸ãƒ³ã‚’envã‹ã‚‰å–å¾—
          origin: [process.env.FRONTEND_DOMAIN || 'http://localhost:3001'], 
          // preflightã®æ™‚ã¯Controllerã¾ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã«è¡Œã‹ãªã„ã‚ˆã†ã«ã™ã‚‹
          preflightContinue: false, 
          // GETã€POSTã€PUTã€OPTIONSã®ã¿è¨±å¯ã™ã‚‹
          methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'], 
          // è¨±å¯ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼é …ç›®ã‚’æŒ‡å®šã™ã‚‹
          allowedHeaders: ['Origin','X-Requested-With','Content-Type','Accept','Authorization','Cookie','Referer'],
          credentials: true,
        },
        // ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨˜è¼‰ https://docs.nestjs.com/techniques/logger
        logger: ['log', 'debug', 'error', 'warn'],
      });

      app.setGlobalPrefix('v1');                                  // v1ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æœ‰åŠ¹åŒ–
      app.use(cookieParser());                                    // cookieParserã®é©ç”¨
      app.useGlobalFilters(new HttpExceptionFilter());            // Filterã®Globalè¨­å®š
      app.useGlobalInterceptors(new LoggingInterceptor());        // Interceptorã®Globalè¨­å®š
      app.use(requestContext.middleware(MIDDLEWARE_NAME_SPACE));  // request-contextã®Globalè¨­å®š

      //Swagger
      const unintegratedSiteOptions = new DocumentBuilder()
        .setTitle('TRYT Worker API Documents')
        .setDescription('TRYT Worker API Documents')
        .setVersion('1.0')
        .build();
      const document = SwaggerModule.createDocument(app, unintegratedSiteOptions);
      const yamlDocument = dump(document);
      writeFileSync('../docs/openapi.yml', yamlDocument, 'utf8');

      //URL API
      SwaggerModule.setup('v1/api', app, document);

      await app.listen(Number(process.env.LISTEN_PORT));
    }
    bootstrap();

- KEY: nest.sample.model
  EXPLAIN: Model(Entity)
  BODY: |
    â–  Base
    import { CreateDateColumn, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

    export class Base {
      @PrimaryGeneratedColumn({ comment: 'ID' })  //ã‚·ãƒ¼ã‚±ãƒ³ã‚¹è‡ªå‹•ç”Ÿæˆ(æŒ¿å…¥æ™‚)
      id: number;

      @CreateDateColumn()                         //æ—¥ä»˜è‡ªå‹•ç”Ÿæˆ(æŒ¿å…¥æ™‚)
      created_at: Date;

      @UpdateDateColumn()                         //æ—¥ä»˜è‡ªå‹•ç”Ÿæˆ(æŒ¿å…¥æ™‚ãƒ»æ›´æ–°æ™‚)
      updated_at: Date;
    }

    â–  Extended
    import { IsOptional, Max, MaxLength } from 'class-validator';
    import { Base } from '../entities/base.entity';
    import { Entity, Column, Index } from 'typeorm';

    @Entity('general')
    export class DataGeneral extends Base {
      @Index()                                    // æ¤œç´¢Indexä½œæˆ
      @MaxLength(10)                              // validation(æœ€å¤§10æ–‡å­—)
      @Column('varchar', { length: 16, comment: 'åå‰', nullable: false })
      name: string;

      @Max(100)                                   // validation(æœ€å¤§å€¤100)
      @Column({ comment: 'å¹´é½¢' })
      age: number;

      @IsOptional()                               // validation(ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«)
      @Column({ comment: 'æœ‰åŠ¹', default: false })
      act?: boolean;
      // act? ã§ãªãã¨ã‚‚ã€default: false ã®æŒ‡å®šãŒã‚ã‚Œã° SQL ã¯insert OK
      // TS ã¨ SQL å¿…é ˆé …ç›®ã¯åˆ¥ç‰©
    }

- KEY: nest.sample.service
  EXPLAIN: Service
  BODY: |
    â–  æ³¨æ„: Deprecated
    const person = await getConnection();
    const person = await getManager();
    const person = await getRepository();

    â–  constructor ã¨ DI
    import { Injectable } from '@nestjs/common';
    import { InjectRepository } from '@nestjs/typeorm';
    import { Repository } from 'typeorm';
    import { DataGeneral } from './general.entity'; // â­•Entity

    @Injectable()
    export class DataGeneralService {
      constructor(
        @InjectRepository(DataGeneral)            // â­•å¿˜ã‚Œãšã«
        private readonly repoGeneral: Repository<DataGeneral>,
      ) {}

- KEY: nest.sample.service.get
  EXPLAIN: Service:Get
  BODY: |
    async findAll(): Promise<DataGeneral[]> {
      return await this.repoGeneral.find();
    }

    async findAll_QB(): Promise<DataGeneral[]> {
      return await this.repoGeneral.createQueryBuilder().getMany();
    }

    async getByName(name: string): Promise<DataGeneral | null> {
      return await this.repoGeneral.findOne({
        where: { name }
      });
    }

    async getByID(id: number): Promise<DataGeneral | null> {
      return await this.repoGeneral.findOne({
        where: { id }
      });
    }

    async getByID_QB(id: number): Promise<DataGeneral | null> {
      return await this.repoGeneral
        .createQueryBuilder()
        .where('id=:id', { id })
        .getOne();
    }

- KEY: nest.sample.service.insert
  EXPLAIN: Service:Insert
  BODY: |
    â–  repository.insert()
    async insert(
      data: Partial<DataGeneral> | Partial<DataGeneral>[],
    ): Promise<boolean> {
      try {
        await this.repoGeneral.insert(data);
        return true;
      } catch (error) {
        console.log(error?.sqlMessage);
        throw error;
      }
    }

    â–  repository.insert()ã®æˆ»ã‚Šå€¤
    const result: InsertResult = await this.repoGeneral.insert(data);

    InsertResult {
      identifiers: [ { id: 4 } ],
      generatedMaps: [
        {
          id: 4,
          created_at: 2023-09-21T22:47:30.725Z,
          updated_at: 2023-09-21T22:47:30.725Z,
          act: false
        }
      ],
      raw: ResultSetHeader {
        fieldCount: 0,
        affectedRows: 1,
        insertId: 4,
        info: '',
        serverStatus: 2,
        warningStatus: 0,
        changedRows: 0
      }
    }

    â–  .createQueryBuilder().insert()
    async insert_QB(
      data: Partial<DataGeneral> | Partial<DataGeneral>[],
    ): Promise<boolean> {
      try {
        await this.repoGeneral
          .createQueryBuilder()
          .insert()
          .into(DataGeneral)
          .values(data)                           //é…åˆ—ã‚‚OK, {act: false}
          .execute();
        return true;
      } catch (error) {
        console.log(error?.sqlMessage);
        throw error;
      }
    }

- KEY: nest.sample.service.update
  EXPLAIN: Service:Update
  BODY: |
    â–  repository.update()
    async update(name: string, data: Partial<DataGeneral>): Promise<boolean> {
      try {
        await this.repoGeneral.update(
          { name },                               //SQL:where
          { ...data },                            //SQL:values
        );
        return true;
      } catch (error) {
        console.log(error?.sqlMessage);
        throw error;
      }
    }

    â–  repository.update()ã®æˆ»ã‚Šå€¤
    const result: UpdateResult = await this.repoGeneral.update(...);

    UpdateResult { generatedMaps: [], raw: [], affected: 1 } //æˆåŠŸ
    UpdateResult { generatedMaps: [], raw: [], affected: 0 } //å¤±æ•—

    â–  .createQueryBuilder().update()
    async update_QB(name: string, data: Partial<DataGeneral>): Promise<boolean> {
      try {
        await this.repoGeneral
          .createQueryBuilder()
          .update(DataGeneral)
          .set(data)
          .where('name=:name', { name })
          .execute();
        return true;
      } catch (error) {
        console.log(error?.sqlMessage);
        throw error;
      }
    }

- KEY: nest.sample.service.upsert
  EXPLAIN: Service:Upsert
  BODY: |
    â–  repository.upsert()
    async upsert(data: Partial<DataGeneral>): Promise<boolean> {
      try {
        await this.repoGeneral.upsert(
          { ...data }, //SQL:values
          { conflictPaths: ['name'] },            //é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚«ãƒ©ãƒ  **Unique IndexåŒ–å¿…é ˆ!
        );

        return true;
      } catch (error) {
        console.log(error?.sqlMessage);
        throw error;
      }
    }

    â–  .createQueryBuilder().upsert()
    async upsert_QB(data: Partial<DataGeneral>): Promise<boolean> {
      try {
        await this.repoGeneral
          .createQueryBuilder()
          .insert()
          .into(DataGeneral)
          .values(data)
          .orUpdate(['name', 'age'], ['name'])    //([updateå¯¾è±¡ã‚«ãƒ©ãƒ ,...],[é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚«ãƒ©ãƒ ])
          .execute();

        return true;
      } catch (error) {
        console.log(error?.sqlMessage);
        throw error;
      }
    }

- KEY: nest.sample.service.delete
  EXPLAIN: Service:Delete
  BODY: |
    â–  .delete()
    async delete(name: string): Promise<boolean> {
      try {
        await this.repoGeneral.delete({ name });
        return true;
      } catch (error) {
        console.log(error?.sqlMessage);
        throw error;
      }
    }

    â–  .delete()ã®æˆ»ã‚Šå€¤
    const result: DeleteResult = await this.repoGeneral.delete(...)

    DeleteResult { raw: [], affected: 1 }         //æˆåŠŸ
    DeleteResult { raw: [], affected: 0 }         //å¤±æ•—

    â–  .createQueryBuilder().delete()
    async delete_QB(name: string): Promise<boolean> {
      try {
        await this.repoGeneral
          .createQueryBuilder()
          .delete()
          .from(DataGeneral)
          .where('name=:name', { name })
          .execute();
        return true;
      } catch (error) {
        console.log(error?.sqlMessage);
        throw error;
      }
    }

- KEY: nest.sample.controller
  EXPLAIN: controllerã®åŸºç¤
  BODY: |
    â–  URL PATH
    /tasks      GET    getTasks          @Get()
    /tasks/[id] GET    getTaskById       @Get(/:id)
    /tasks      POST   createTask        @Post()
    /tasks/[id] PATCH  updateTask        @Patch(/:id)
    /tasks/[id] DELETE deleteTask        @Delete(/:id)

    â–  å®Ÿè£…
    @Controller('tasks')
    export class TasksController {
      @Get()                                      // å–å¾—: GET
      getTasks(){ ... }

      @Get('/:id')                                // å–å¾—: GET
      getTaskById( ... ){ ... }

      @Post()                                     // ç”Ÿæˆ: CREATE
      createTask( ... ){ ... }

      @Patch('/:id')                              // æ›´æ–°: UPDATE
      updateTask( ... ){ ... }

      @Delete('/:id')                             // å‰Šé™¤: DELETE
      deleteTask( ... ){ ... }
    }

- KEY: nest.sample.controller.Controller
  EXPLAIN: Controller
  BODY: |
    import { Controller,Get,Post,Body,HttpException,Param,ParseIntPipe,Put,Delete }
      from '@nestjs/common';
    import { GeneralRequest } from './dto/general.request.entity';
    import { DataGeneralService } from './general.service';
    import { ERROR_OBJECT } from '@/constants/errors';

    @Controller('general')
    export class DataGeneralController {
      constructor(private readonly service: DataGeneralService) {}

      @Get()
      async serviceName() {
        try { ... } catch (e) {
          throw new HttpException({ ...ERROR_OBJECT, error: e.message }, 500);
        }
      }
    }

- KEY: nest.sample.controller.error
  EXPLAIN: Controller:ErrorObject
  BODY: |
    import { HttpStatus } from "@nestjs/common";
    export const ERROR_OBJECT = {
      status: HttpStatus.INTERNAL_SERVER_ERROR,
      error: "Internal server error.",
    };

- KEY: nest.sample.controller.get
  EXPLAIN: Controller:Get()
  BODY: |
    ğŸŸ curl -XGET http://localhost:3000/general/

    @Get()
    async findAll() {
      try {
        return await this.service.findAll_QB();
      } catch (e) {
        throw new HttpException({ ...ERROR_OBJECT, error: e.message }, 500);
      }
    }

- KEY: nest.sample.controller.getByName
  EXPLAIN: Controller:Get('name/:name')
  BODY: |
    ğŸŸ curl -XGET http://localhost:3000/general/name/john

    @Get('name/:name')
    async findByName(@Param('name') name: string) {
      try {
        return await this.service.getByName(name);
      } catch (e) {
        throw new HttpException({ ...ERROR_OBJECT, error: e.message }, 500);
      }
    }

- KEY: nest.sample.controller.getByID
  EXPLAIN: Controller:Get('id/:id')
  BODY: |
    ğŸŸ curl -XGET http://localhost:3000/general/id/1

    @Get('id/:id')
    async findByID(@Param('id', ParseIntPipe) id: number) {
      try {
        return await this.service.getByID(id);
      } catch (e) {
        throw new HttpException({ ...ERROR_OBJECT, error: e.message }, 500);
      }
    }

- KEY: nest.sample.controller.insert
  EXPLAIN: Controller:Post()
  BODY: |
    ğŸŸ curl -XPOST -H "Content-Type: application/json"
      -d '{"name":"Bill","age":18}' http://localhost:3000/general/

    @Post()
    async insert(@Body() data: GeneralRequest): Promise<boolean> {
      try {
        return await this.service.insert(data);
      } catch (e) {
        throw new HttpException({ ...ERROR_OBJECT, error: e.message }, 500);
      }
    }

- KEY: nest.sample.controller.update
  EXPLAIN: Controller:Put(':name')
  BODY: |
    ğŸŸ curl -XPUT -H "Content-Type: application/json"
      -d '{"age":28}' http://localhost:3000/general/Bill

    @Put(':name')
    async update(
      @Param('name') name: string,
      @Body() data: GeneralRequest,
    ): Promise<boolean> {
      try {
        return await this.service.update(name, data);
      } catch (e) {
        throw new HttpException({ ...ERROR_OBJECT, error: e.message }, 500);
      }
    }

- KEY: nest.sample.controller.upsert
  EXPLAIN: Controller:Post('ups')
  BODY: |
    ğŸŸ curl -XPOST -H "Content-Type: application/json"
      -d '{"name":"Bill","age":9}' http://localhost:3000/general/ups

    @Post('ups')
    async upsert(@Body() data: GeneralRequest): Promise<boolean> {
      try {
        return await this.service.upsert(data);
      } catch (e) {
        throw new HttpException({ ...ERROR_OBJECT, error: e.message }, 500);
      }
    }

- KEY: nest.sample.controller.delete
  EXPLAIN: Controller:Delete(':name')
  BODY: |
    ğŸŸ curl -XDELETE http://localhost:3000/general/Bill2

    @Delete(':name')
    async delete(@Param('name') name: string): Promise<boolean> {
      try {
        return await this.service.delete(name);
      } catch (e) {
        throw new HttpException({ ...ERROR_OBJECT, error: e.message }, 500);
      }
    }
