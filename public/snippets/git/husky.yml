---
#-------------------------------
# husky
#-------------------------------

- ENTRY:
  CATEGORY: husky & lint-staged

- ENTRY:
  EXPLAIN: インストール
  BODY: |
    ■ 概要

    ・変更を git にコミットする前に、自動でコードチェックやフォーマットを実行するためのツール

      husky: Git フックを簡単に管理・設定できるツール
      lint-staged: ステージされたファイルに対してのみリントやフォーマットを実行するツール

    ■ husky & lint-staged

      npm install -D husky lint-staged

    ■ package.json に prepare スクリプトを追加（CIや新規クローン時に自動セットアップ）

      "scripts": {
        "prepare": "husky install"
      }

    ■ pre-commit フック作成（lint-staged を呼ぶ）:

      1) 特定ファイル追加

      npx husky add .husky/pre-commit "npx lint-staged"

      2) husky 初期化

      npx husky install
      npx husky init

      以下のファイルを生成
      .husky/_/prepare-commit-msg
      .husky/_/pre-commit                           // コミット前
      .husky/_/pre-rebase
      .husky/_/pre-push                             // プッシュ前
      .husky/_/pre-auto-gc
      .husky/_/pre-applypatch
      .husky/_/post-rewrite
      .husky/_/post-merge
      .husky/_/post-commit
      .husky/_/post-checkout
      .husky/_/post-applypatch

    ■ package.json に lint-staged 設定例

      "lint-staged": {
        "*.{js,jsx,ts,tsx}": ["eslint --fix", "prettier --write"]
      }

      通常の開発フロー: ファイルをステージ → git commit → pre-commit が実行 → 失敗ならコミット中止

    ■ DIR内の構成

    .husky/husky.sh             // 中身が空
    .husky/pre-commit

- ENTRY:
  EXPLAIN: 設定
  BODY: |
    ■ [pre-commit]

      #!/usr/bin/env sh
      . "$(dirname -- "$0")/husky.sh"   # 中身が空

      npx lint-staged

    ■ 必須 [package.json]
      "lint-staged": {
        "*.{js,jsx,ts,tsx}": "npm run lint"
      },

    ■ 必須 [.lintstagedrc.js] Sample

    export default {
      '**/*.{ts,tsx}': [
        () => 'tsc --incremental false --noEmit', // 型チェック
      ],
    };

    ■ 必須 [.lintstagedrc.js] Callback Samples

    export default {
      '**/*.ts?(x)': () => 'tsc -p tsconfig.json --noEmit',
      'src/**/*.{js,jsx,ts,tsx}': 'eslint --fix --no-ignore --max-warnings=0',
      'src/**/*.{css,scss}': 'stylelint --fix',
      'src/**/*': 'prettier --write --ignore-unknown'
    }

    ■ 必須 [.lintstagedrc.js] Next Sample

      const path = require('path');

      const buildEslintCommand = (filenames) =>
        `next lint --fix --file ${filenames
          .map((f) => path.relative(process.cwd(), f))
          .join(' --file ')}`;

      module.exports = {
        '*.{ts,tsx}': [
          () => 'tsc --incremental false --noEmit', // 型チェック
          buildEslintCommand,

          // Prettierフォーマット(必要に応じて)
          // "prettier --write --ignore-path .gitignore './**/*.{js,jsx,ts,tsx,json,css}'",
        ],
      };

- ENTRY:
  EXPLAIN: Git Action による pre-commit
  BODY: |
    ■ [.git/hooks/pre-commit]

    huskyを使用せずに、git action による

    #!/bin/bash
    cd ./src         # Target Directory

    targetFiles=$(git diff --staged --relative --name-status --diff-filter=AM  | grep -E "\.(ts|tsx|js|jsx|json|md)" | sed -e "s/^.*\t//")
    yarn run eslint ${targetFiles}
    if [ $? != "0" ] ; then
        exit 1
    fi

    BRANCH=$(git symbolic-ref HEAD | sed -e "s|^refs/heads/||")
    if [ $BRANCH = "develop" ] || [ $BRANCH = "main" ]; then
        echo "${BRANCH}へのコミットは禁止です"
        exit 1
    fi

- ENTRY:
  EXPLAIN: commit 時に YAML lint を実行
  BODY: |
    ■ [.husky/pre-commit]

      #!/usr/bin/env sh
      . "$(dirname -- "$0")/husky.sh"

      # Run YAML lint before other lint-staged hooks
      npm run lint:yaml || exit 1

      npx lint-staged

    ■ [package.json]

      "scripts": {
        "lint:yaml": "node scripts/lint-yaml.js",
      }

    ■ [scripts/lint-yaml.js]

      #!/usr/bin/env node
      import fs from "fs"
      import path from "path"
      import YAML from "yaml"

      const root = process.cwd()
      const target = path.join(root, "public", "snippets")

      function walk(dir) {
        const entries = fs.readdirSync(dir, { withFileTypes: true })
        for (const ent of entries) {
          const p = path.join(dir, ent.name)
          if (ent.isDirectory()) {
            walk(p)
          } else if (ent.isFile() && (p.endsWith(".yml") || p.endsWith(".yaml"))) {
            try {
              const src = fs.readFileSync(p, "utf8")
              YAML.parse(src)
              console.log("OK", p)
            } catch (e) {
              console.error("ERROR", p)
              console.error(e && e.message ? e.message : String(e))
              process.exitCode = 2
            }
          }
        }
      }

      try {
        if (!fs.existsSync(target)) {
          console.error("TARGET_NOT_FOUND", target)
          process.exit(2)
        }
        walk(target)
        if (process.exitCode && process.exitCode !== 0) process.exit(process.exitCode)
        process.exit(0)
      } catch (err) {
        console.error("WALK_ERROR", err && err.message ? err.message : String(err))
        process.exit(2)
      }
