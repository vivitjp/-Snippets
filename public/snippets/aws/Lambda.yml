---
#-------------------------------
# Lambda関数の基本
#-------------------------------
- ENTRY:
  CATEGORY: Lambda

- ENTRY:
  EXPLAIN: 概要
  BODY: |
    ■ サポート言語
      ・Python, Node.js, .NET, Go, Java, Ruby, Custom Runtime

    ■ 概要

      ・コード実行のサーバー管理の必要がなく、イベントに応じて自動的にスケール
      ・AWS Lambdaは、サーバーレスアーキテクチャを実現するためのサービス
      ・AWS Lambdaで実行されるコードの単位で、イベントソースからのイベントをトリガーにして実行
      ・AWS Management Console、AWS CLI、AWS SDKで作成
      ・AWS Lambdaの管理コンソールからも作成可能
      ・それぞれ隔離されたコンテナで実行され、1コンテナで1つのLambda関数が実行される
      ・関数メソッドをハンドラーとして指定、ハンドラ内ではパラメタとしてイベントデータ(JSON)を受け取る
      ・コードは依存関係も含めてビルド、パッケージングしてZIPファイルに圧縮してアップロード
      ・ULしたコードはS3に暗号化して保存され、Lambda関数の実行時にS3から取得
      ・ユーザがS3にアップロードしてARNで指定することも可能
      ・Lambda関数の実行時間はデフォルト3秒から最大900秒(15分)まで、実行時間を超えるとタイムアウト

    ■ AWS Serverless Application Repository

      ・AWS Lambdaのアプリケーションを管理するためのサービス

    ■ AWS CloudFormation

      ・リソース定義とプロビジョニング自動化

    ■ AWS SAM (Serverless Application Model)

      ・サーバーレスアプリケーション定義とデプロイのためのフレームワーク
      ・AWS CloudFormationの拡張(従来のCloudFormationテンプレートをSAMテンプレートに変換可能)

    ■ AWS CLI & AWS SAM CLI

      ・コマンドラインツール
      ・デプロイパッケージのアップロードやテンプレート更新
      ・AWS SAM CLIはテンプレート検証、ローカル開発、テスト、デバッグが可能

    ■ 同時実行数制限

      ・Lambda関数の同時実行数はデフォルト1000、アカウント単位で制限されている
        ・エラー: スロットリングエラー(429)
        ・非同期の場合、15~30分はバーストとして許容される
        ・同時実行数の制限はAWS Lambdaのサービスクォータで確認可能

      ・同時実行数の見積
        ・同時実行数 = (1秒あたりのリクエスト数) x (Lambda関数の平均実行時間)
        ・例: 1秒あたり100リクエスト、平均実行時間が0.5秒の場合、50同時実行数必要 
        ・ポーリングベースについては別途考慮

    ■ 自動スケーリング

      ・Lambda関数は自動的にスケール
      ・同時実行数の制限があるため、リクエスト数が多い場合はスロットリングエラー発生
      ・初期レベルでバーストした場合、負荷が落ち着くまで、あるいは同時実行の制限に達するまで、1分ごとに500ずつ実行
        ・初期値はリージョンによって異なる(緩和不可)
          例: us-east-1は500、ap-northeast-1は1000
          
    ■ 緩和可能

      ・同時実行数制限(デフォルト1000)
      ・関数とレイヤーストレージ(75GB)

    ■ 緩和不可

      ・メモリ(128MB~10GB)
      ・タイムアウト(1s~900s = 15分)
      ・環境変数(4KB)
      ・関数リソースポリシー(20KB?)
      ・関数レイヤー(5レイヤー)
      ・呼び出しペイロード(同期 6MB, 非同期 256KB)
      ・パッケージサイズ(zipの直UL 50MB, 解凍時 250MB, コンソールからのアップロード 3MB)
      ・テストイベント(10)
      ・/tmp ディレクトリのストレージ(512MB)
      ・ファイルの説明(1024)
      ・実行プロセス/スレッド数(1024)
      ・VPC内でのENI作成時間(10s~60s程度)
      ・VPC内でのENI数(5~10個程度)

- ENTRY:
  EXPLAIN: イベントソースとトリガー
  BODY: |
    ■ イベントソース

    ・Cognito User Pools                  非同期
    ・Amazon S3                           非同期
    ・Amazon DynamoDB Streams             同期 (ポーリングベース: DynamoDB Streams)
    ・Amazon Simple Notification Service  非同期
    ・Amazon Simple Email Service         非同期
    ・Amazon Simple Queue Service         同期 (ポーリングベース: 非ストリームベース)
    ・AWS CloudFormation                  同期
    ・Amazon CloudWatch Logs              同期
    ・Amazon CloudWatch イベント           非同期
    ・Amazon API Gateway                  同期
    ・Amazon CloudFront                   同期

    ■ トリガー

    ・Lambda関数をトリガーするイベントソースを指定可能
    ・トリガーはAWSサービスからのイベントをLambda関数に送信
    ・カスタムAPPによるトリガー、AWS CLIなどによる手動実行時に呼び出しタイプを指定
    ・イベントソースがAWSサービスの場合、事前にタイプ指定して変更不可
    ・非同期呼び出し
      ・InvocationType: Event
      ・レスポンスはリクエストが正常に受付されたかどうかのみ
    ・同期呼び出し
      ・InvocationType: RequestResponse
      ・実行完了後にレスポンスを返し、内容はLambda関数の戻り値

    ■ リトライ

    ・非同期呼び出し
      ・自動的に2回までリトライ(最大で6分間隔)され、その後イベントは破棄
      ・リトライには遅延あり(指数バックオフ・アルゴリズム)
    ・同期呼び出し
      ・リトライなし、エラーが発生した場合はレスポンス・ヘッダにエラーコードが返される
      ・パーミッション、IAMロールの設定ミスなどによるエラー:
        ・場合はリトライされず、特定のステータスコードが返される

    ■ VPC内で実行する場合

    ・VPCのサブネットとセキュリティグループを指定
    ・Lambda関数はVPC内のリソースにアクセスできる反面: 
      ・インターネットアクセスは不可になる
      ・Public IPアドレスが持てない
      ・インターネットアクセスが必要な場合、VPC NAT Gateway使用
    ・ENI(Elastic Network Interface)使用
      ・Lambda関数の実行時にENIを作成、実行終後、ENIは削除される
      ・VPC内リソースへのアクセスに、IAMロール(AWSLambdaVPCAccessExecutionRole)指定
      ・任意のアドレス指定は不可
      ・ENI作成時間により初回実行時にレイテンシー(10s~60s程度)が発生する
      ・ENIは複数のLambda関数で共有される

    ■ アクセス許可(管理ポリシー)

    ・Lambda関数の実行に必要なIAMロール指定(AWSリソースにアクセスする許可)
    ・管理ポリシー例:
      ・AWSLambdaBasicExecutionRole      CloudWatch Logsへの書き込み
      ・AWSLambdaVPCAccessExecutionRole  VPCアクセスのためのENI管理アクセス
      ・AWSLambdaDynamoDBExecutionRole   DynamoDBへのアクセス
      ・AWSLambdaSQSQueueExecutionRole   SQSへのアクセス

    ■ アクセス許可(リソースポリシー)

    ・Lambda関数のリソースポリシーを設定することで、AWSサービスやユーザにLambda関数の実行許可
    ・リソースポリシーはIAMロールではなく、Lambda関数に直接アタッチされるポリシー
    ・リソースポリシー例:
      ・S3バケットからのLambda関数の呼び出しを許可するポリシー
      ・API GatewayからのLambda関数の呼び出しを許可するポリシー
      ・SNSからのLambda関数の呼び出しを許可するポリシー

- ENTRY:
  EXPLAIN: イベント型
  BODY: |
    ■ Cognito User Pools

      トリガー種別 (triggerSource) により request/response の形が変わる
      Pre sign-up, Post authentication, Pre token generation など

      {
        "version": 1,
        "triggerSource": "PostAuthentication_Authentication",
        "region": "ap-northeast-1",
        "userPoolId": "ap-northeast-1_xxxxxxxxx",
        "userName": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
        "callerContext": {
          "awsSdkVersion": "aws-sdk-unknown-version",
          "clientId": "xxxxxxxxxxxxxxxxxxxxxxxxxx"
        },
        "request": {
          "userAttributes": {
            "sub": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
            "email_verified": "true",
            "email": "user@example.com"
          }
        },
        "response": {}
      }

    ■ S3

      Records 配列にオブジェクト操作ごとのレコードが入る
      s3.bucket.name / s3.object.key でバケットとキーを取得

      {
        "Records": [
          {
            "eventVersion": "2.1",
            "eventSource": "aws:s3",
            "awsRegion": "ap-northeast-1",
            "eventName": "ObjectCreated:Put",
            "s3": {
              "bucket": {
                "name": "my-bucket",
                "arn": "arn:aws:s3:::my-bucket"
              },
              "object": {
                "key": "path/to/object.txt",
                "size": 1024,
                "eTag": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
                "sequencer": "0A1B2C3D4E5F678901"
              }
            }
          }
        ]
      }

    ■ DynamoDB Streams


    ■ Simple Notification Service


    ■ Simple Email Service


    ■ Simple Queue Service


    ■ CloudFormation


    ■ CloudWatch Logs


    ■ CloudWatch イベント


    ■ API Gateway


    ■ CloudFront

- ENTRY:
  EXPLAIN: ライフサイクル
  BODY: |
    1 ENI作成                     VPC使用時のみ10~30s(Durationには含まれない)
    2 コンテナ作成                 S3からのダウンロードと展開(Durationには含まれない)
    3 デプロイパッケージのロード
    4 デプロイパッケージの展開
    5 ランタイム起動と初期化        グローバルスコープ処理含む(Durationには含まれない)
    6 関数実行                     Durationに含まれる(実行時間)
    7 コンテナ破棄

    ■ コールドスタート & ウォームスタート

    ・1~6 まで全実行するのがコールドスタート(毎回実行)
    ・作成コンテナ再利用ではウォームスタート(初回実行後、一定時間内に再実行)

    ■ コールドスタートが起こる条件

    ・コンテナない場合
    ・Lambda関数の初回実行時
    ・Lambda関数のコード変更時(コンテナ作り直し)
    ・Lambda関数のVPC設定変更時(コンテナ作り直し)
    ・Lambda関数の同時実行数制限を超えた場合(ENI作成)
    ・Lambda関数のアイドル時間が長い場合(ENI削除)

    ■ 対策

    ・Lambda関数のアイドル時間を短くする(多くが無駄!)
      ・定期的にLambda関数を実行する(CloudWatch Eventsなど)
      ・Lambda関数のアイドル時間を短くすることで、コールドスタートを減らす

    ■ バックグラウンドプロセスの凍結と再開

    ・Lambda関数終了時にバックグラウンドプロセスがある場合、凍結される
    ・凍結されたバックグラウンドプロセスは、次回関数を呼び出した際に再開
      ・ただし、コンテナが再利用される場合のみで保証なし(この挙動に依存しないこと)

#-------------------------------
# 実装
#-------------------------------
- ENTRY:
  CATEGORY: 実装

- ENTRY:
  EXPLAIN: サンプル
  BODY: |
    ■ Lambda関数サンプル (Node.js)

    exports.handler = async (event, context) => {                    // エントリーポイント
      try {
        console.log('event:', JSON.stringify(event, null, 2));       // ロギング

        const remainingTime = context.getRemainingTimeInMillis();    // コンテキスト(残り実行時間取得)
        console.log('Remaining time:', remainingTime, 'ms');

        const result = {                                             // 処理結果
          message: 'Hello from Lambda!',
          input: event,                                              // イベントデータ
          timestamp: new Date().toISOString(),
        };

        console.log('result:', JSON.stringify(result, null, 2));     // ロギング: 結果の出力

        return {                                                     // 正常レスポンス
          statusCode: 200,
          body: JSON.stringify(result),
        };

      } catch (error) {                                              // 例外処理
        console.error('Error occurred:', error);

        return {                                                     // エラーレスポンス
          statusCode: 500,
          body: JSON.stringify({
            error: error.message,
          }),
        };
      }
    };

    ■ コールバック使用サンプル

      exports.handler = (event, context, callback) => {
        try {
          const result = { message: 'Hello from Lambda!' };
          callback(null, result);  // 成功時(第2引数に結果を渡す)
          // return result;        // ❌️ return文は使用不可
        } catch (error) {
          callback(error);         // エラー時(第1引数にエラーオブジェクトを渡す)
        }
      };

      ※ 注意
      ・コールバックへの引数は2つまで
      ・コールバック使用時は非同期関数(async)は使用しない
      ・return文は使用せず、コールバックで結果を返す
      ・コールバックとreturn文を混在させないこと
      ・コールバック使用時は context.succeed() や context.fail() は使用しないこと
      ・コールバック使用時は例外が発生した場合、自動的にエラーレスポンスが返される

      ・callback を使用するハンドラをコールするイベント
        ・AWS Lambdaがサポートするすべてのイベントソース
          ・API Gateway、S3、DynamoDB、SNS、SQSなどのイベントソース
        ・カスタムアプリケーションからの呼び出しでも使用可能

- ENTRY:
  EXPLAIN: サンプル解説
  BODY: |
    ■ ハンドラー

    ・AWS Lambdaが呼び出すメソッドのエントリーポイント(実行開始点)
    ・Lambda関数のコード内で定義必要

    ■ イベント(1つ目の引数)

    ・Lambda関数がトリガーされたときに渡されるデータオブジェクト
    ・イベントソースによって内容が異なる(JSON)

      例: API Gatewayからのイベント
      {
        "resource": "/myresource",
        "path": "/myresource",
        "httpMethod": "GET",
        "headers": { ... },
        "queryStringParameters": { ... },
        "pathParameters": { ... },
        "stageVariables": { ... },
        "requestContext": { ... },
        "body": null,
        "isBase64Encoded": false
      }

      例: S3からのイベント
      {
        "Records": [
          {
            "eventVersion": "2.1",
            "eventSource": "aws:s3",
            "awsRegion": "us-east-1",
            "eventTime": "2020-09-30T12:34:56.000Z",
            "eventName": "ObjectCreated:Put",
            "s3": {
              "bucket": { "name": "my-bucket", ... },
              "object": { "key": "my-object-key", ... }

    ■ コンテキスト(2つ目の引数)

    ・Lambda関数の実行環境に関する情報オブジェクト
    ・関数実行中に取得可能(実行完了後は取得不可)
    ・実行時間、メモリサイズ、リクエストIDなどの情報
      ・context.get_remaining_time_in_millis(): 実行時間取得
      ・context.function_name: 関数名
      ・context.memory_limit_in_mb: メモリサイズ(MB)
      ・context.aws_request_id: リクエストID

    ■ コールバック(3つ目の引数)

    ・引数は2つ
      ・第1引数にエラーオブジェクトを渡すと関数実行を終了
      ・第2引数に結果を渡すことで、関数の実行結果を返す
    ・コールバックなし: return文で結果を返す
    ・コールバックあり: return文は使用不可

    ■ ロギング

    ・AWS LambdaはCloudWatch Logsにログを出力を出力可能
    ・ロググループ名: /aws/lambda/<関数名>
    ・ログストリーム名: <YYYY/MM/DD>/<関数名>/<リクエストID>
    ・ログストリームはLambda関数の実行ごとに作成

    ■ 例外

    ・Lambda関数内で例外が発生した場合、AWS Lambdaは自動的にエラーをキャッチ
    ・エラーはCloudWatch Logsに出力される
    ・エラーが発生した場合、Lambda関数の実行は終了し、エラーコードが返される
    ・エラーコードはAWS Lambdaの管理コンソールから確認可能
    ・エラーコードはAWS CLIやAWS SDKを使用して取得可能

    ■ ステートレス

    ・Lambda関数はステートレス

    ■ ローカルファイルへのアクセス

    ・関数内でローカルファイルにアクセスする場合、/tmpディレクトリを使用
    ・/tmpディレクトリは512MBまで使用可能
    ・/tmpディレクトリはLambda関数の実行ごとに初期化される

    ■ 永続化

    ・Lambda関数内で永続化する場合、Amazon S3やDynamoDBを使用
    ・Amazon S3やDynamoDBはAWS Lambdaから直接アクセス可能

- ENTRY:
  EXPLAIN: マネジメントコンソールからのLambda関数の作成
  BODY: |
    ■ マネジメントコンソールからのLambda関数の作成

    ・AWS Management ConsoleからLambda関数を作成する場合、以下の手順で作成可能
      1. AWS Management Consoleにログイン
      2. Lambdaサービスを選択
      3. 「関数の作成」をクリック
      4. 「一から作成」を選択
      5. 関数名、ランタイム、ロールを指定
      6. 「関数の作成」をクリック

    ■ 設計図の使用

    ・設計図はAWS Lambdaのサンプルコードを元に作成されたテンプレート
    ・設計図を使用することで、Lambda関数の作成が簡単になる
    ・設計図はAWS Management ConsoleからLambda関数を作成する際に選択可能

#-------------------------------
# デプロイ
#-------------------------------
- ENTRY:
  CATEGORY: デプロイ

- ENTRY:
  EXPLAIN: デプロイ
  BODY: |
    ■ デプロイパッケージ

    ・ZIPファイルに圧縮してアップロードする必要がある
    ・ZIPファイルは依存関係も含めてビルド、パッケージングしてアップロード
    ・依存関係の含め方は言語によって異なる
      ・Node.js: 依存ライブラリはnode_modulesに格納したZIPファイルをアップロード
      ・Python: 依存ライブラリはsite-packagesに格納したZIPファイルをアップロード
    ・依存ライブラリに対してグローバルな読み取り権限(0444)が必要

    ■ 制限

    ・AWS Management Consoleからアップロードする場合、3MBまで
    ・MAXサイズは50MBまで(解凍後のサイズは250MBまで)。
    ・50MBを超える場合、S3にアップロードしてARN指定
    ・解凍後のサイズは250MBまで

    ■ バージョニング

    ・各バージョンには一意のARNが付与される
    ・関数作成/更新時に自動的にバージョンが付与される
    ・PublishVersionを使用してバージョン公開
    ・バージョンは1から始まり、1ずつ増加、最大1000
    ・バージョン発行までは $LATEST が使用される
    ・特定バージョンに対してエイリアスを作成可能(番号でなく名前指定)
    ・特定バージョンを指定して関数を呼び出すことができる
      ・例: arn:aws:lambda:us-east-1:123456789012:function:my-function:1     <-- バージョン番号
      ・例: arn:aws:lambda:us-east-1:123456789012:function:my-function:PROD  <-- エイリアス名

    ■ タグによるグループ化とフィルタリング

    ・タグは最大50個まで付与可能
    ・タグは最大128バイトまでの文字列
    ・請求に含まれるLambda関数のリストをグループ化
    ・コンソールとAWS CLIからLambda関数をフィルタリング

- ENTRY:
  EXPLAIN: 環境変数
  BODY: |
    ■ 環境変数

    ・環境変数はLambda関数の実行時に取得可能
    ・環境変数はLambda関数の実行ごとに初期化される
    ・バージョニング利用時は環境変数もスナップショットされる
    ・4KBまでのサイズ制限あり
    ・環境変数はAWS Management Consoleから設定可能
    ・文字は[a-zA-Z]で始まり、英数字とアンダースコアのみ使用可能で、文字コードは UTF-8

    ■ 暗号化

    ・AWS KMS(Key Management Service)を使用して暗号化可能
    ・KMSで暗号化され、Lambda関数の実行時に復号化される
    ・KMSで暗号化されているため、IAMポリシーでアクセス制御可能
    ・復号化はLambda関数の実行時に行われる

    ■ Node.js サンプル

    ・let region = process.env.AWS_REGION
    ・let bucket = process.env.BUCKET_NAME
    ・let key = process.env.KEY_NAME
    ・let value = process.env.VALUE_NAME
    ・let secret = process.env.SECRET_NAME

- ENTRY:
  EXPLAIN: 予約済み環境変数
  TABLE:
    OPTION:
      ALIGN:
        - left
        - left
      HAS_TITLE: false
      WIDTH:
        - 40%
    BODY: |
      ■ 予約済み環境変数
      _HANDLER	関数に設定されているハンドラの場所
      AWS_DEFAULT_REGION	Lambda 関数が実行されるデフォルトの AWS リージョン
      AWS_REGION	Lambda 関数が実行される AWS リージョン定義されている場合、この値は AWS_DEFAULT_REGION を上書きします
      AWS_EXECUTION_ENV	AWS_Lambda_ (例: AWS_Lambda_java8) のプレフィックスが付いたランタイム識別子、この環境変数は OS 専用ランタイム (provided ランタイムファミリー) には定義されていません
      AWS_LAMBDA_FUNCTION_NAME	関数の名前
      AWS_LAMBDA_FUNCTION_MEMORY_SIZE	関数で使用できるメモリの量 (MB 単位)
      AWS_LAMBDA_FUNCTION_VERSION	実行される関数のバージョン
      AWS_LAMBDA_INITIALIZATION_TYPE	関数の初期化タイプ
      AWS_LAMBDA_LOG_GROUP_NAME、AWS_LAMBDA_LOG_STREAM_NAME	Amazon CloudWatch Logs グループの名前と関数のストリーム
      	AWS_LAMBDA_LOG_GROUP_NAME および AWS_LAMBDA_LOG_STREAM_NAME の環境変数は Lambda SnapStart 関数では使用できません
      AWS_ACCESS_KEY、AWS_ACCESS_KEY_IDAWS_SECRET_ACCESS_KEY、AWS_SESSION_TOKEN	関数の実行ロールから取得したアクセスキー
      AWS_LAMBDA_RUNTIME_API	(カスタムランタイム) ランタイム API のホストおよびポート
      LAMBDA_TASK_ROOT	Lambda 関数コードへのパス
      LAMBDA_RUNTIME_DIR	ランタイムライブラリへのパス

      ■ 予約されていない環境変数
      LANG	ランタイムのロケール (en_US.UTF-8)
      PATH	実行パス (/usr/local/bin:/usr/bin/:/bin:/opt/bin)
      LD_LIBRARY_PATH	システムライブラリのパス (/var/lang/lib:/lib64:/usr/lib64:$LAMBDA_RUNTIME_DIR:$LAMBDA_RUNTIME_DIR/lib:$LAMBDA_TASK_ROOT:$LAMBDA_TASK_ROOT/lib:/opt/lib)
      NODE_PATH	(Node.js) Node.js ライブラリのパス (/opt/nodejs/node12/node_modules/:/opt/nodejs/node_modules:$LAMBDA_RUNTIME_DIR/node_modules)
      PYTHONPATH	(Python) Python ライブラリパス ($LAMBDA_RUNTIME_DIR)
      TZ	環境のタイムゾーン (:UTC) 実行環境は、システムクロックを同期するために NTP を使用します。

- ENTRY:
  EXPLAIN: Layersで「分離管理」
  BODY: |
    ■ 概要

    ・Lambda関数の「コード」と「依存ライブラリ」を分離管理可能
    ・Lambda関数のコードは Lambda Layers に格納され、Lambda関数から参照される
    ・Lambda Layersは最大5つ、最大75GBまで使用可能
    ・AWS Management Console、AWS CLI、AWS SDKから作成可能
    ・共通コンポーネントをZIPファイルに圧縮して「Lambda Layers」としてアップロード
    ・Lambda LayersはLambda関数の実行時に自動的にマウントされる
    ・Layersはimmutable(不変)で、バージョン管理される
    ・指定バージョンが削除/利用権限剥奪時、それを利用する関数は稼働するが、新規作成は不可

    ■ マネジメントコンソール「レイヤーの作成」

    「Lambda」->「Layers」->「レイヤーの作成」
    ・名前: 任意の名前を指定
    ・説明: 任意の説明を指定
    ・コードエントリタイプ: ZIPファイル/S3バケット指定
    ・アップロード: ZIPファイル/S3バケット指定
    ・ランタイム: 対応するランタイムを指定(Node.js, Python, ... + バージョン)

    ■ マネジメントコンソール「関数にレイヤーを追加」

    「Lambda」->「Layers」->「関数にレイヤーを追加」
    ・レイヤー選択
      ・リストからレイヤーを選択
      ・レイヤーARNを指定
    ・関数の「Configuration」から「Layers」を確認

    ■ 注意点

    ・/opt の下に指定した順番で展開
    ・/opt の下に各言語の依存を解決する固有のPATHが設定される
      ・node.js: /opt/nodejs/node_modules
      ・Lambda関数のコードは/var/taskに展開される

#-------------------------------
# エラーとロギング
#-------------------------------
- ENTRY:
  CATEGORY: モニタリング、ロギング、エラー

- ENTRY:
  EXPLAIN: CloudWatchによるモニタリング
  BODY: |
    ■ 概要

    ・AWS CloudWatchを使用してLambda関数のメトリクスを収集
    ・Lambda関数のメトリクスはCloudWatchに自動的に送信される
    ・CloudWatch LogsにLambda関数のログを出力可能
    ・CloudWatch LogsはAWS Management Consoleから確認可能
    ・CloudWatch LogsはAWS CLIやAWS SDKを使用して取得可能
  TABLE:
    OPTION:
      ALIGN:
        - left
        - center
        - left
      HAS_TITLE: true
      WIDTH:
        - 30%
        - 10%
    BODY: |
      項目	単位	意味
      Invocations	count	Lambda関数の呼び出し回数(課金対象と同等)
      Duration	ms	Lambda関数の実行時間(課金は100ms単位で切り上げ)。コールドスタートのLambda起動までは含まない
      Errors	count	Lambda関数のエラー回数(Throttlesと内部エラーは除く)
      Throttles	count	Lambda関数のスロットリング回数(制限緩和のエビデンスになる)
      IteratorAge	ms	(Kinesis/DynamoDBストリームのみ) イテレータの年齢
      DeadLetterErrors	count	Dead Letter Queueの書き込み失敗回数
      ConcurrentExecutions	count	同時実行数
      UnreservedConcurrentExecutions	count	予約されていない同時実行数

- ENTRY:
  EXPLAIN: CloudWatch の ログ出力
  BODY: |
    実行ログが CloudWatch Logs に出力される

    exports.handler = function(event, context){
        console.log('Received event:');
        console.log(JSON.stringify(event, null, 2));
        var bucket = event.Records[0].s3.bucket.name;
        var key = event.Records[0].s3.object.key;
        console.log('Bucket: ' + bucket);
        console.log('Key: ' + key);
    };

- ENTRY:
  EXPLAIN: エラー発生状況
  BODY: |
    ■ スロットリング

      ・AWS Lambdaにおける同時実行数の制限を超えた場合に発生するエラー状態

      ・ネットワークでの発生
        ・非VPC: 実行時にENIを作成せず、スロットリング非発生
        ・VPC内: ENI作成で、スロットリング発生
        ・Lambda関数の同時実行数が制限を超えた場合に発生
        ・429エラーコードが返される

    ■ 同時実行数

      ・予約されていないアカウントの同時実行の使用
      ・同時実行の予約: 100

    ■ デバッグとエラー処理

      ・DLQ(Dead Letter Queue) リソース: 関数実行に失敗した場合、SNSやSQSにメッセージを送信

    ■ 監査とコンプライアンス

      ・AWS CloudTrail: Lambda関数の実行履歴を記録
      ・AWS Config: Lambda関数の設定変更を記録

#-------------------------------
# Schedule 実行
#-------------------------------
- ENTRY:
  CATEGORY: Schedule 実行

- ENTRY:
  EXPLAIN: Schedule 実行
  BODY: |
    ■ 概要 

    ・AWS Lambdaは定期的に実行可能
    ・AWS CloudWatch Events
      ・定期的にLambda関数を実行可能
      ・AWS Management Consoleから設定可能
      ・AWS CLIやAWS SDKを使用して設定可能
      ・AWS Lambda関数をトリガーとして実行可能

    ■ マネジメントコンソール「トリガーの設定」

    ・ルール: 新規ルールの作成
    ・ルール名: 任意の名前を指定
    ・ルールの説明: 任意の説明を指定
    ・ルールのタイプ: 
      ・イベントパターン
      ・スケジュール式を選択

    ■ スケジュール式の例

    ・rate(5 minutes)                 5分ごとに実行
    ・rate(1 hour)                    1時間ごとに実行
    ・rate(7 days)                    7日ごとに実行
    ・cron(0 12 * * ? *)              毎日12時に実行
    ・cron(0 10 * * ? *)              毎日午前10時に実行
    ・cron(0 18 ? * MON-FRI *)        月～金、毎日午後6時に実行

#-------------------------------
# カスタムランタイム
#-------------------------------
- ENTRY:
  CATEGORY: カスタム・ランタイム

- ENTRY:
  EXPLAIN: カスタム・ランタイム
  BODY: |
    ■ 概要

    ・Linux 互換のランタイムを指定することで任意の言語を実行
    ・先に公式サポートを確認
      AWS LambdaはLinux互換のカスタムランタイムをサポート
      https://github.com/awslabs

    ■ bootstrap

    ・エントリポイントとなる実行ファイル
    ・Runtime HTTP API と 実行関数の間をつなぐインターフェース
    ・レスポンスとエラーハンドリング、コンテキスト作成と関数実行を行う
    ・関数実行時にパッケージ内/Layer内の bootstrap を実行
    ・存在しないとエラーになる

    ■ 例: コンパイル言語 fortran

    ・Lambdaはまず"bootstrap"という名前のスクリプトを探し、存在すればそれを実行
    ・Fortranのようなコンパイル言語では bootstrap スクリプトと実行バイナリをzipに入れる
    ・あるいは Layer に登録してもOK
    ・bootstrap から実行バイナリを実行

- ENTRY:
  EXPLAIN: bootstrap実装
  BODY: |
    ■ Initialization Tasks(請求/タイムアウト対象)

      ・環境変数の読み取り
      ・関数で設定されたハンドラの取得(FILE_NAME.METHOD_NAME)
        ・LAMBDA_TASK_ROOT: Lambda関数コードへのパス
        ・AWS_LAMBDA_RUNTIME_API: Lambda Runtime APIのホスト名とポート番号
      ・関数の初期化
        ・ハンドラ読み込み、初期化、グローバル変数の初期化
        ・SDKクラインアント、DB接続、HTTPクライアントの初期化(再利用対象)
      ・エラーハンドリング

    ■ Processing Tasks(イベント待ち受けループ)

      ・イベントの取得
        ・next invocation APIを使用して次イベント取得
        ・イベントはJSON形式で取得
      ・コンテキストオブジェクト作成
        ・イベントデータを元にコンテキストオブジェクト作成
        ・コンテキストオブジェクトにはLambda関数の実行環境に関する情報が含まれる
      ・関数のハンドラを呼び出し(イベント処理)
        ・イベントとコンテキスオブジェクトをハンドラに渡す
      ・レスポンスのハンドリング
        ・レスポンスはJSON形式で取得
        ・レスポンスボディには関数の実行結果が含まれる
        ・レスポンスヘッダにはリクエストIDが含まれる
        ・Invocation Response APIを使用してレスポンスをポスト
      ・エラーハンドリング
        ・エラー発生時、Invocation Error APIを使用してエラーをポスト
      ・クリーンアップ
        ・Lambda関数の実行が終了したら、クリーンアップ処理を実行
        ・DB接続のクローズ、HTTPクライアントのクローズなど
        ・他サービスへデータ送信、次イベント処理前の追加処理など

- ENTRY:
  EXPLAIN: bootstrapサンプル(shell script)
  BODY: |
    #!/bin/sh
    set -ueo pipefail

    # 初期化 - 関数ハンドラロード
    source $LAMBDA_TASK_ROOT/"$(echo $_HANDLER | cut -d. f1).sh"

    # 実行
    while true
    do
      HEADERS="$(mktemp)"

      # イベント取得
      EVENT_DATA=$(curl -sS -LD "$HEADERS" -X GET "http://${AWS_LAMBDA_RUNTIME_API}/2018-06-01/runtime/invocation/next")
      REQUEST_ID=$(grep -Fi Lambda-Runtime-Aws-Request-Id "$HEADERS" | tr -d '[:space:]' | cut -d: -f2)

      # ハンドラ関数実行
      RESPONSE=$($(echo "$_HANDLER" | cut -d. -f2) "$EVENT_DATA")

      # レスポンス送信
      curl -X POST "http://${AWS_LAMBDA_RUNTIME_API}/2018-06-01/runtime/invocation/$REQUEST_ID/response" -d "$RESPONSE"
    done

- ENTRY:
  EXPLAIN: カスタムランタイムのための HTTP API
  BODY: |
    API メソッド
    ・次の呼び出し
    ・呼び出しレスポンス
    ・初期化エラー
    ・呼び出しエラー

    ■ 次の呼び出し
      ・PATH: /runtime/invocation/next
      ・メソッド: GET
      ・ランタイムは、このメッセージを Lambda に送信、呼び出しイベントをリクエスト
      ・レスポンス本文: 
        ・呼び出しのペイロード(関数トリガーのイベントデータを含む JSON ドキュメント)が含まれる。
      ・レスポンスヘッダー: 
        ・Lambda-Runtime-Aws-Request-Id
            リクエスト ID
            関数の呼び出しをトリガーしたリクエストを識別
            例: 8476a536-e9f4-11e8-9739-2dfe598c3fcd
        ・Lambda-Runtime-Deadline-Ms
            関数がタイムアウトした日付 (Unix 時間のミリ秒)
            例: 1542409706888
        ・Lambda-Runtime-Invoked-Function-Arn
            呼び出しで指定されている Lambda 関数、バージョン、またはエイリアスの ARN
            例: arn:aws:lambda:us-east-2:123456789012:function:custom-runtime
        ・Lambda-Runtime-Trace-Id - AWS X-Ray トレースヘッダー。
            例: Root=1-5bef4de7-ad49b0e87f6ef6c87fc2e700;Parent=9a9197af755a6419;Sampled=1
        ・Lambda-Runtime-Client-Context
            AWS Mobile SDK の呼び出しにおいて、クライアントアプリケーションおよびデバイスに関するデータ
        ・Lambda-Runtime-Cognito-Identity
            AWS Mobile SDK からの呼び出しの場合は、Amazon Cognito ID プロバイダーに関するデータ

      ・応答遅延の可能性があり、GET リクエストにタイムアウトを設定しないこと
          Lambda がランタイムをブートストラップする時と、返すイベントがランタイムにあるときとの間に、
          ランタイムプロセスが数秒間停止する可能性あり
      ・リクエスト ID は、Lambda 内の呼び出しを追跡
          レスポンス送信時に呼び出しを指定する場合に使用
      ・トレースヘッダーには、トレース ID、親 ID、サンプリングデシジョンが含まれます。
          リクエストがサンプリングされている場合、リクエストが Lambda、またはアップストリームサービスによってサンプリングされた場合、
          ランタイムは、_X_AMZN_TRACE_ID をヘッダーの値に設定します。
          X-Ray SDK はこの値を読み込んで ID を取得し、リクエストを追跡するかどうかを判断します。

    ■ 呼び出しレスポンス
    ■ 初期化エラー
    ■ 呼び出しエラー

#-------------------------------
#  CLI
#-------------------------------
- ENTRY:
  CATEGORY: AWS CLI

- ENTRY:
  EXPLAIN: 概要
  BODY: |
    ■ 概要

    ・AWS CLIを使用してLambda関数を操作可能
    ・各種コマンドを使用してLambda関数の作成、取得、更新、削除、呼び出しが可能
    ・最新バージョン: aws-cli/2.x
    ・v1 と v2 の違い
      ・v2 は新しい機能と改善が含まれている
      ・v2 は Python 3.x を使用している
      ・v2 は Windows でのインストールが簡単になっている
      ・v2 は SSO (Single Sign-On) をサポートしている

    ■ インストール

    npm install -g aws-cli@latest

    ■ メソッド一覧

    ・create-function                   関数作成（ZIPまたはS3からコードをアップロード、ロール・ランタイム指定）
    ・get-function                      関数コードとメタデータを取得
    ・get-function-configuration        関数設定のみ取得（メモリ、タイムアウト等）
    ・update-function-code              関数コードをZIPで更新（S3または--zip-file）
    ・update-function-configuration     ランタイム、メモリ、タイムアウト等の設定更新
    ・delete-function                   関数削除
    ・list-functions                    リージョン内の関数一覧を取得
    ・invoke-function                   関数を同期/非同期で呼び出し（--payload指定）
    ・publish-version                   現行コードをバージョンとして発行
    ・create-alias                      バージョンへエイリアス作成（トラフィック分割に使用）
    ・update-alias                      エイリアスのターゲットバージョンを更新
    ・delete-alias                      エイリアス削除
    ・list-aliases                      関数のエイリアス一覧取得
    ・add-permission                    関数に対する呼び出し許可を追加（Principal指定）
    ・remove-permission                 指定した許可の削除
    ・get-policy                        関数のリソースポリシーを取得
    ・tag-resource                      関数にタグを付与
    ・untag-resource                    関数からタグを削除
    ・list-versions-by-function         関数のバージョン一覧を取得

- ENTRY:
  EXPLAIN: create-function
  BODY: |
    ■ 概要

    ・Lambda関数を作成

    ■ サンプル

    aws lambda create-function \
      --function-name my-function \
      --runtime nodejs14.x \
      --role arn:aws:iam::123456789012:role/lambda-execution-role \
      --handler index.handler \
      --zip-file fileb://function.zip

#-------------------------------
#  SDK
#-------------------------------
- ENTRY:
  CATEGORY: SDK

- ENTRY:
  EXPLAIN: 概要
  BODY: |
    ■ 概要

    ・AWS SDK for JavaScript v3 を使用して Lambda 関数を操作可能
    ・LambdaClient クラスを使用して Lambda クライアントを作成
    ・各種コマンドクラスを使用して Lambda 関数の作成、取得、更新、削除、呼び出しが可能
    ・非同期関数(async/await)を使用して非同期処理を簡単に記述可能

    ■ インストール

    npm install @aws-sdk/client-lambda

    ■ メソッド一覧

    ・ CreateFunction                    関数作成(ZIPまたはS3からコードをアップロードし実行ロール、ランタイム指定)
    ・ GetFunction                       関数コードとメタデータを取得
    ・ GetFunctionConfiguration          関数設定のみ取得（メモリ、タイムアウト等）
    ・ UpdateFunctionCode                関数コードをZIPで更新（S3またはZipFile）
    ・ UpdateFunctionConfiguration       ランタイム、メモリ、タイムアウト等の設定更新
    ・ DeleteFunction                    関数削除
    ・ ListFunctions                     リージョン内の関数一覧を取得
    ・ Invoke                            関数を同期/非同期で呼び出し（ペイロード送信）
    ・ PublishVersion                    現行コードをバージョンとして発行
    ・ CreateAlias                       バージョンへの別名作成（トラフィック分割に使用）
    ・ UpdateAlias                       エイリアスのターゲットバージョンを更新
    ・ DeleteAlias                       エイリアス削除
    ・ ListAliases                       関数のエイリアス一覧取得
    ・ AddPermission                     関数に対する呼び出し許可を追加（Principal指定）
    ・ RemovePermission                  指定した許可の削除
    ・ GetPolicy                         関数のリソースポリシーを取得
    ・ TagResource                       関数にタグを付与
    ・ UntagResource                     関数からタグを削除
    ・ ListVersionsByFunction            関数のバージョン一覧を取得

    ■ 関数名管理

    ・命名規則 (例)
      ・環境-サービス-処理 形式: prod-api-auth, dev-batch-daily
      ・サービス-用途 形式: notification-send-email, order-process-payment
      ・プロジェクト-モジュール 形式: myapp-user-handler

    ・制約
      ・最大 64 文字 (unqualified)。英数字とハイフン (-) のみ推奨
      ・同一リージョン・同一アカウントで一意である必要あり
      ・作成後のリネームは不可。変更時は新規作成してトリガーを付け替える

    ・Tips
      ・環境 (dev/stg/prod) をプレフィックスに入れると ListFunctions のフィルタや権限分離に便利
      ・短すぎると衝突しやすく、長すぎると ARN やログの可読性が下がる
      ・バージョンやエイリアスで出し分ける場合は関数名は用途で固定し、Qualifier で切り替える

    ■ Handler

    ・CreateFunction / UpdateFunctionConfiguration で指定するエントリポイント文字列
    ・形式はランタイムにより異なる。Node.js は「ファイル名.エクスポート名」が一般的

    ・形式の例 (ランタイム別)
      ・Node.js: index.handler (index.js の exports.handler)
      ・Python:  lambda_function.lambda_handler (lambda_function.py の lambda_handler)
      ・その他:  各ランタイムのドキュメントを参照

    ・Node.js ハンドラの引数
      ・event: object。Invoke の Payload またはトリガー (API Gateway, S3 等) から渡るイベント
      ・context: object。requestId, functionName, getRemainingTimeInMillis() 等の実行コンテキスト

    ・Tips
      ・ハンドラ名を変える場合は UpdateFunctionConfiguration の Handler で更新可能
      ・同一 ZIP 内に複数エントリを用意し、関数ごとに別ハンドラを指定することも可能

- ENTRY:
  EXPLAIN: CreateFunction
  BODY: |
    ■ 概要

    ・Lambda 関数を新規作成する SDK メソッド
    ・ZIP または S3 からコードを渡し、ランタイム・ロール・ハンドラを指定する
    ・CreateFunctionCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・新規 Lambda 関数をコードから自動作成する (CI/CD や IaC)
    ・S3 に置いた ZIP を参照して関数をデプロイする
    ・テンプレートやスクリプトから同一設定の関数を複数作成する
    ・マネージドコンソールではなく SDK/CLI で関数を一括登録する

    ■ サンプル

      const { LambdaClient, CreateFunctionCommand } = require('@aws-sdk/client-lambda');
      const fs = require('fs');

      const client = new LambdaClient({ region: 'ap-northeast-1' });
      const zip = fs.readFileSync('./function.zip');

      const command = new CreateFunctionCommand({
        FunctionName:    'my-function',
        Runtime:         'nodejs20.x',
        Role:            'arn:aws:iam::123456789012:role/lambda-execution-role',
        Handler:         'index.handler',
        Code:            { ZipFile: zip },
        // Code:         { S3Bucket: 'my-bucket', S3Key: 'my-function.zip' }  // S3運用時
        MemorySize:      256,
        Timeout:         30,
        Environment: {
          Variables: { NODE_ENV: 'production' },
        },
      });

      const result = await client.send(command);

      // 重要な戻り値の実際の例 (抜粋)
      const resultExample = {
        FunctionArn:     'arn:aws:lambda:ap-northeast-1:123456789012:function:my-function',
        CodeSize:        1024,
        LastModified:    '2024-01-15T12:34:56.000+0000',
        CodeSha256:      'a1b2c3d4e5f6789...',
        Version:         '$LATEST',
        State:           'Pending',
        ... 残りは引数と同値
      };

    ■ 引数(必須)

    ・FunctionName: string           関数名、同一リージョン・同一アカウントで一意
    ・Runtime: string                ランタイム、例: nodejs20.x, python3.12
    ・Role: string                   lambda.amazonaws.com の信頼ポリシーを持つ IAM ロールの ARN
    ・Handler: string                エントリポイント、例: index.handler
    ・Code: object                   デプロイパッケージ、ZipFile (Buffer) または S3Bucket + S3Key

        ※ 注意
        ・ZipFile は zip の直アップロード時 50MB、解凍後 250MB まで
        ・超過時は S3 に置き S3Bucket/S3Key で指定
        ・同一 FunctionName が既に存在する場合は ResourceConflictException
        ・更新は UpdateFunctionCode / UpdateFunctionConfiguration を使用

    ■ 引数(任意)

    ・MemorySize: number             メモリ MB、128~10240、デフォルト 128
    ・Timeout: number                最大実行秒、1~900、デフォルト 3
    ・Environment: object            Variables にキー/値の環境変数
    ・VpcConfig: object              SubnetIds, SecurityGroupIds で VPC 内実行
    ・Architectures: string[]        x86_64 または arm64、省略時は x86_64
    ・PackageType: string            Zip または Image
    ・Tags: object                   リソースタグのキー/値

        ※ 注意
        ・VpcConfig を付けると ENI 作成のため初回実行が遅くなる場合あり

    ■ 戻り値(重要)

    ・FunctionArn: string            作成された関数の ARN (引数にない)
    ・CodeSize: number               デプロイパッケージのバイト数
    ・LastModified: string           最終更新日時 (ISO8601)
    ・CodeSha256: string             デプロイパッケージの SHA256
    ・Version: string                バージョン ($LATEST)
    ・State: string                  作成直後は Pending、のち Active

      ※ CodeSha256 の用途: デプロイパッケージのハッシュ値を取得し、更新前後の比較に使用
         コードの変更を検知すると、更新前後のハッシュ値が異なるので、更新が必要か判断可能
         更新が必要な場合は、UpdateFunctionCode を使用して更新

    ■ 戻り値(引数と同値)

    ・FunctionName: string           関数名
    ・Runtime: string                ランタイム
    ・Handler: string                ハンドラ
    ・Role: string                   実行ロール ARN
    ・Description: string            説明 (指定時のみ)
    ・Timeout: number                タイムアウト秒
    ・MemorySize: number             メモリ MB
    ・PackageType: string            Zip または Image
    ・Architectures: string[]        アーキテクチャの配列
    ・Environment: object            Variables (指定時のみ)
    ・VpcConfig: object              SubnetIds, SecurityGroupIds (指定時のみ)

- ENTRY:
  EXPLAIN: GetFunction
  BODY: |
    ■ 概要

    ・関数のメタデータとコードの取得先を返す SDK メソッド
    ・GetFunctionConfiguration は設定のみ、GetFunction は設定に加え Code (ダウンロード URL 等) と Tags を返す
    ・GetFunctionCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・デプロイ済みの関数コードを署名付き URL でダウンロードする
    ・Configuration とタグをまとめて取得し、一覧や監視に利用する
    ・CodeSha256 でローカルとリモートのコード差分を判定し、更新要否を決める
    ・特定バージョンやエイリアス (Qualifier) の設定・コードを取得する

    ■ サンプル

      const { LambdaClient, GetFunctionCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new GetFunctionCommand({
        FunctionName: 'my-function',
        // Qualifier: '1',  // バージョンまたはエイリアス (任意)
      });

      const result = await client.send(command);

      // 重要な戻り値の実際の例 (抜粋)
      const resultExample = {
        Configuration: {
          FunctionArn:  'arn:aws:lambda:ap-northeast-1:123456789012:function:my-function',
          FunctionName: 'my-function',
          Runtime:      'nodejs20.x',
          Handler:      'index.handler',
          CodeSize:     1024,
          State:        'Active',
          LastModified: '2024-01-15T12:34:56.000+0000',
          ... 他は GetFunctionConfiguration と同様
        },
        Code: {
          Location:       'https://... (署名付き URL、デプロイパッケージのダウンロード用)',
          RepositoryType: 'S3',
        },
        Tags: { env: 'production' },
      };

    ■ 引数(必須)

    ・FunctionName: string           関数名、ARN、または部分 ARN。最大 170 文字

    ■ 引数(任意)

    ・Qualifier: string              バージョン番号またはエイリアス。省略時は $LATEST。最大 128 文字

        ※ 注意
        ・存在しない関数名の場合は ResourceNotFoundException
        ・Code.Location は署名付き URL のため有効期限あり (数分〜数十分)、取得後は早めにダウンロード

    ■ 戻り値(重要)

    ・Configuration: object          関数設定 (GetFunctionConfiguration と同じ形)
    ・Code: object                   コードの取得先。Zip 時は Location (署名付き URL) と RepositoryType: 'S3'
    ・Tags: object                   リソースタグのキー/値 (指定時のみ)

      ※ Code.Location: デプロイパッケージをダウンロードするための署名付き URL。ブラウザや curl で取得可能

    ■ 戻り値(Configuration の主な内容)

    ・FunctionArn: string            関数の ARN
    ・FunctionName: string           関数名
    ・Runtime: string                ランタイム
    ・Handler: string                ハンドラ
    ・Role: string                   実行ロール ARN
    ・CodeSize: number               デプロイパッケージのバイト数
    ・CodeSha256: string             デプロイパッケージの SHA256
    ・LastModified: string           最終更新日時 (ISO8601)
    ・Version: string                バージョン
    ・State: string                  Active など
    ・Timeout: number                タイムアウト秒
    ・MemorySize: number             メモリ MB
    ・Environment: object            Variables (指定時のみ)
    ・VpcConfig: object              SubnetIds, SecurityGroupIds (指定時のみ)

- ENTRY:
  EXPLAIN: GetFunctionConfiguration
  BODY: |
    ■ 概要

    ・関数の設定のみを取得する SDK メソッド
    ・GetFunction は設定に加え Code (ダウンロード URL) と Tags を返すが、本メソッドは設定のみで軽量
    ・GetFunctionConfigurationCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・コードやタグが不要で、設定 (メモリ、タイムアウト、環境変数等) だけ参照する
    ・一覧取得 (ListFunctions) 後に各関数の詳細設定を取得する
    ・CodeSha256 や LastModified でデプロイ状態の確認や差分判定に使う
    ・特定バージョンやエイリアス (Qualifier) の設定のみ取得する

    ■ サンプル

      const { LambdaClient, GetFunctionConfigurationCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new GetFunctionConfigurationCommand({
        FunctionName: 'my-function',
        // Qualifier: '1',  // バージョンまたはエイリアス (任意)
      });

      const result = await client.send(command);

      // 戻り値の実際の例 (抜粋)
      const resultExample = {
        FunctionArn:   'arn:aws:lambda:ap-northeast-1:123456789012:function:my-function',
        FunctionName:  'my-function',
        Runtime:       'nodejs20.x',
        Handler:       'index.handler',
        Role:          'arn:aws:iam::123456789012:role/lambda-execution-role',
        CodeSize:      1024,
        CodeSha256:    'a1b2c3d4e5f6789...',
        LastModified: '2024-01-15T12:34:56.000+0000',
        Version:       '$LATEST',
        State:         'Active',
        Timeout:       30,
        MemorySize:    256,
        Environment:   { Variables: { NODE_ENV: 'production' } },
      };

    ■ 引数(必須)

    ・FunctionName: string           関数名、ARN、または部分 ARN。最大 170 文字

    ■ 引数(任意)

    ・Qualifier: string              バージョン番号またはエイリアス。省略時は $LATEST。最大 128 文字

        ※ 注意
        ・存在しない関数名の場合は ResourceNotFoundException
        ・コードのダウンロードは GetFunction の Code.Location を使用する

    ■ 戻り値(主な内容)

    ・FunctionArn: string            関数の ARN
    ・FunctionName: string           関数名
    ・Runtime: string                ランタイム
    ・Handler: string                ハンドラ
    ・Role: string                   実行ロール ARN
    ・CodeSize: number               デプロイパッケージのバイト数
    ・CodeSha256: string             デプロイパッケージの SHA256
    ・LastModified: string           最終更新日時 (ISO8601)
    ・Version: string                バージョン
    ・State: string                  Active など
    ・Timeout: number                タイムアウト秒
    ・MemorySize: number             メモリ MB
    ・Description: string            説明 (指定時のみ)
    ・Environment: object            Variables、Error (指定時のみ)
    ・VpcConfig: object              SubnetIds, SecurityGroupIds (指定時のみ)
    ・PackageType: string            Zip または Image
    ・Architectures: string[]        アーキテクチャの配列

- ENTRY:
  EXPLAIN: UpdateFunctionCode
  BODY: |
    ■ 概要

    ・既存 Lambda 関数のデプロイパッケージ (コード) のみを更新する SDK メソッド
    ・ZIP または S3 を指定し、ランタイム・ハンドラ等の設定は変更しない
    ・UpdateFunctionCodeCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・CI/CD でビルドした ZIP をデプロイする
    ・GetFunction の CodeSha256 と比較し、変更がある場合のみ本メソッドで更新する
    ・S3 にアップロード済みの ZIP を参照して関数を更新する

    ■ サンプル

      const { LambdaClient, UpdateFunctionCodeCommand } = require('@aws-sdk/client-lambda');
      const fs = require('fs');

      const client = new LambdaClient({ region: 'ap-northeast-1' });
      const zip = fs.readFileSync('./function.zip');

      const command = new UpdateFunctionCodeCommand({
        FunctionName: 'my-function',
        Code:         { ZipFile: zip },
        // Code: { S3Bucket: 'my-bucket', S3Key: 'my-function.zip' }  // S3 運用時
        // Publish: true,  // 新バージョンとして発行する場合
      });

      const result = await client.send(command);
      // 戻り値は FunctionConfiguration 形式 (GetFunctionConfiguration と同様)

    ■ 引数(必須)

    ・FunctionName: string           更新対象の関数名、ARN、または部分 ARN
    ・Code: object                   デプロイパッケージ。ZipFile (Buffer) または S3Bucket + S3Key

        ※ 注意
        ・ZipFile は直アップロード 50MB、解凍後 250MB まで。超過時は S3 で指定
        ・更新中は State が Pending になり、完了後に Active

    ■ 引数(任意)

    ・Publish: boolean                true で更新後に新バージョンとして発行
    ・DryRun: boolean                 true で検証のみ実行し、実際には更新しない
    ・RevisionId: string              楽観ロック。指定時は現在の RevisionId と一致する場合のみ更新
    ・Architectures: string[]        x86_64 または arm64

    ■ 戻り値

    ・GetFunctionConfiguration と同じ FunctionConfiguration 形式 (FunctionArn, CodeSize, CodeSha256, LastModified, State 等)

- ENTRY:
  EXPLAIN: UpdateFunctionConfiguration
  BODY: |
    ■ 概要

    ・既存 Lambda 関数の設定 (ランタイム、メモリ、タイムアウト、環境変数等) を更新する SDK メソッド
    ・コードは変更せず、ハンドラ・メモリ・タイムアウト・VPC・環境変数などを更新する
    ・UpdateFunctionConfigurationCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・メモリやタイムアウトを変更する
    ・環境変数を追加・変更する
    ・VPC 設定やランタイム・ハンドラを変更する
    ・デプロイ後に設定だけチューニングする

    ■ サンプル

      const { LambdaClient, UpdateFunctionConfigurationCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new UpdateFunctionConfigurationCommand({
        FunctionName: 'my-function',
        MemorySize:   512,
        Timeout:      60,
        Environment: {
          Variables: { NODE_ENV: 'production', LOG_LEVEL: 'debug' },
        },
      });

      const result = await client.send(command);
      // 戻り値は FunctionConfiguration 形式

    ■ 引数(必須)

    ・FunctionName: string           更新対象の関数名、ARN、または部分 ARN

    ■ 引数(任意)

    ・Runtime: string                ランタイム、例: nodejs20.x
    ・Handler: string                エントリポイント
    ・Role: string                   実行ロール ARN
    ・Description: string            説明
    ・Timeout: number                最大実行秒、1~900
    ・MemorySize: number             メモリ MB、128~10240
    ・Environment: object            Variables にキー/値の環境変数
    ・VpcConfig: object              SubnetIds, SecurityGroupIds。空で VPC 解除
    ・Layers: string[]               レイヤー ARN の配列
    ・RevisionId: string             楽観ロック

        ※ 注意
        ・指定した項目のみ更新され、省略した項目は現状維持
        ・VpcConfig を変更すると ENI の再作成で初回実行が遅くなる場合あり

    ■ 戻り値

    ・GetFunctionConfiguration と同じ FunctionConfiguration 形式

- ENTRY:
  EXPLAIN: DeleteFunction
  BODY: |
    ■ 概要

    ・Lambda 関数を削除する SDK メソッド
    ・削除は不可逆で復元不可。$LATEST を削除すると関数全体が削除され、Qualifier 指定でバージョンまたはエイリアスのみ削除可能
    ・DeleteFunctionCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・不要になった関数を整理する
    ・CI/CD で環境ごとの関数をテアダウンする
    ・特定バージョンやエイリアスだけ削除する (Qualifier 指定)

    ■ サンプル

      const { LambdaClient, DeleteFunctionCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new DeleteFunctionCommand({
        FunctionName: 'my-function',
        // Qualifier: '1',  // 指定時はそのバージョンまたはエイリアスのみ削除
      });

      await client.send(command);
      // 成功時は戻り値なし (204)

    ■ 引数(必須)

    ・FunctionName: string           削除対象の関数名、ARN、または部分 ARN

    ■ 引数(任意)

    ・Qualifier: string              バージョン番号またはエイリアス。省略時は $LATEST を削除し関数全体が消える

        ※ 注意
        ・削除は不可逆。API Gateway や EventBridge 等のトリガー参照は事前に外す
        ・lambda:DeleteFunction の IAM 権限が必要

    ■ 戻り値

    ・成功時は body なし (HTTP 204)。失敗時は ResourceNotFoundException 等

- ENTRY:
  EXPLAIN: ListFunctions
  BODY: |
    ■ 概要

    ・リージョン内の Lambda 関数一覧を取得する SDK メソッド
    ・各要素は FunctionConfiguration 相当 (関数名、ARN、ランタイム、メモリ等)。コードやタグは含まない
    ・ListFunctionsCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・リージョン内の全関数を一覧表示する
    ・名前プレフィックスで絞り込み、該当関数の ARN や設定を取得する
    ・一覧取得後に GetFunction / GetFunctionConfiguration で詳細を取得する

    ■ サンプル

      const { LambdaClient, ListFunctionsCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new ListFunctionsCommand({
        // MaxItems: 50,
        // Marker: '...',           // ページネーション (NextMarker を次回に渡す)
        // FunctionVersion: 'ALL',  // 省略時は $LATEST のみ。ALL で全バージョン
      });

      const result = await client.send(command);
      // result.Functions => FunctionConfiguration の配列
      // result.NextMarker => 次ページがある場合に設定

    ■ 引数(必須)

    ・なし

    ■ 引数(任意)

    ・MaxItems: number               取得する最大件数。デフォルト 50、最大 10000 程度
    ・Marker: string                 ページネーション。前回の NextMarker を渡す
    ・FunctionVersion: string        ALL で全バージョン、省略時は $LATEST のみ

        ※ 注意
        ・リージョン単位。他リージョンは別クライアントで取得
        ・大量の関数がある場合は NextMarker でページング処理する

    ■ 戻り値

    ・Functions: array               FunctionConfiguration の配列 (FunctionName, FunctionArn, Runtime, MemorySize, LastModified 等)
    ・NextMarker: string             次ページがある場合に設定。次回の Marker に渡す

- ENTRY:
  EXPLAIN: Invoke
  BODY: |
    ■ 概要

    ・Lambda 関数を同期または非同期で呼び出す SDK メソッド
    ・InvocationType で RequestResponse (同期) または Event (非同期) を指定
    ・Payload でハンドラの event に渡すデータを指定
    ・InvokeCommand を LambdaClient に渡して実行

    ■ ユースケース

    ・別サービスやスクリプトから Lambda を直接呼び出す
    ・同期で結果を待ち受け、戻り値を利用する (RequestResponse)
    ・非同期で発火だけしてすぐ戻る (Event)
    ・バッチや通知向け
    ・DryRun で権限やパラメータの検証のみ行う

    ■ サンプル

      const { LambdaClient, InvokeCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new InvokeCommand({
        FunctionName:   'my-function',
        InvocationType: 'RequestResponse',  // RequestResponse | Event | DryRun
        Payload:        JSON.stringify({ key: 'value' }),
        // Qualifier: '1',  // バージョンまたはエイリアス
        // LogType: 'Tail', // レスポンスに直近のログを含める
      });

      const result = await client.send(command);
      const payload = JSON.parse(new TextDecoder().decode(result.Payload));

    ■ 引数(必須)

    ・FunctionName: string            呼び出す関数名、ARN、または部分 ARN

    ■ 引数(任意)

    ・InvocationType: string          RequestResponse (同期、デフォルト) / Event (非同期) / DryRun (検証のみ)
    ・Payload: Buffer | Uint8Array    ハンドラの event に渡すデータ。JSON 文字列をエンコードして渡すことが多い
    ・Qualifier: string               バージョン番号またはエイリアス。省略時は $LATEST
    ・LogType: string                 None (デフォルト) / Tail (直近 4KB のログを LogResult に含める)
    ・ClientContext: string           base64 エンコードしたクライアントコンテキスト (モバイル等)

        ※ 注意
        ・同期時は関数の完了またはタイムアウトまで待つ
        ・ペイロード応答は同期 6MB まで
        ・非同期 (Event) は受け付け即 202 で返り、実行結果は受け取れない
        ・リトライは最大 2 回

    ■ 戻り値

    ・StatusCode: number              HTTP ステータス。同期 200、非同期 202、DryRun 204 等
    ・Payload: Uint8Array             同期時はハンドラの戻り値。デコードして利用
    ・ExecutedVersion: string         実行したバージョン (Qualifier 未指定時は $LATEST 等)
    ・FunctionError: string           実行時エラー時は Unhandled / Handled
    ・LogResult: string               LogType: Tail 指定時、base64 エンコードされたログ

- ENTRY:
  EXPLAIN: PublishVersion
  BODY: |
    ■ 概要

    ・$LATEST の現在のコードと設定を不変のバージョンとして発行する SDK メソッド
    ・発行されたバージョンは変更・上書き不可
    ・エイリアスのターゲットや本番参照に使う
    ・PublishVersionCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・本番用に固定バージョンを切り、エイリアス (例: prod) で参照
    ・ロールバック時にエイリアスのターゲットを前のバージョンに切り替える
    ・UpdateFunctionCode の Publish: true と同等の効果を後から取りたい場合

    ■ サンプル

      const { LambdaClient, PublishVersionCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new PublishVersionCommand({
        FunctionName: 'my-function',
        // RevisionId: '...',  // 楽観ロック。一致する場合のみ発行
        // Description: 'Release 1.0.0',
      });

      const result = await client.send(command);
      // result.Version => 新バージョン番号 (例: '1')
      // result.FunctionArn => バージョン付き ARN

    ■ 引数(必須)

    ・FunctionName: string           バージョン発行対象の関数名、ARN、または部分 ARN

    ■ 引数(任意)

    ・RevisionId: string             楽観ロック。現在の RevisionId と一致する場合のみ発行
    ・Description: string            バージョンの説明

        ※ 注意
        ・発行後のバージョンは不変
        ・変更する場合は $LATEST を更新してから再度 PublishVersion
        ・バージョン数に上限あり
        ・不要なバージョンは DeleteFunction に Qualifier で削除可能

    ■ 戻り値

    ・GetFunctionConfiguration と同じ FunctionConfiguration 形式
    ・Version に新バージョン番号、FunctionArn にバージョン付き ARN が入る

- ENTRY:
  EXPLAIN: CreateAlias
  BODY: |
    ■ 概要

    ・バージョンへの別名 (エイリアス) を作成する SDK メソッド
    ・Invoke やトリガーでは Qualifier にエイリアス名を指定でき、実体バージョンを切り替えずに参照先だけ変えられる
    ・CreateAliasCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・本番用エイリアス (prod) をバージョン 1 に向け、デプロイ後に UpdateAlias でバージョン 2 に切り替える
    ・トラフィック分割 (RoutingConfig) で複数バージョンに割合を振り、段階的ロールアウトする

    ■ サンプル

      const { LambdaClient, CreateAliasCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new CreateAliasCommand({
        FunctionName:    'my-function',
        Name:            'prod',
        FunctionVersion: '1',
        // Description: 'Production alias',
        // RoutingConfig: { AdditionalVersionWeights: { '2': 0.1 } },  // 10% を v2 へ
      });

      const result = await client.send(command);
      // result.AliasArn, result.Name, result.FunctionVersion 等

    ■ 引数(必須)

    ・FunctionName: string           対象の関数名、ARN、または部分 ARN
    ・Name: string                   エイリアス名。同一関数内で一意、最大 128 文字
    ・FunctionVersion: string        参照するバージョン番号 (例: 1) または $LATEST

    ■ 引数(任意)

    ・Description: string            エイリアスの説明
    ・RoutingConfig: object          AdditionalVersionWeights でバージョンごとのトラフィック割合 (合計 100%)

    ■ 戻り値

    ・AliasArn, Name, FunctionVersion, Description, RoutingConfig, RevisionId 等のエイリアス情報

- ENTRY:
  EXPLAIN: UpdateAlias
  BODY: |
    ■ 概要

    ・既存エイリアスが参照するバージョンや説明・トラフィック分割を更新する SDK メソッド
    ・本番エイリアス (prod) の FunctionVersion を新バージョンに変えることで、切り替え・ロールアウトが可能
    ・UpdateAliasCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・デプロイ後にエイリアスの参照先を新バージョンに切り替える
    ・トラフィック分割の割合を変更し、段階的ロールアウトやロールバックする

    ■ サンプル

      const { LambdaClient, UpdateAliasCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new UpdateAliasCommand({
        FunctionName:    'my-function',
        Name:            'prod',
        FunctionVersion: '2',
        // Description: 'Production v2',
        // RoutingConfig: { AdditionalVersionWeights: { '1': 0.2, '2': 0.8 } },
      });

      const result = await client.send(command);

    ■ 引数(必須)

    ・FunctionName: string           対象の関数名、ARN、または部分 ARN
    ・Name: string                   更新するエイリアス名

    ■ 引数(任意)

    ・FunctionVersion: string        参照するバージョン番号に更新
    ・Description: string            説明の更新
    ・RoutingConfig: object          AdditionalVersionWeights でトラフィック割合を更新

    ■ 戻り値

    ・AliasArn, Name, FunctionVersion, Description, RoutingConfig, RevisionId 等のエイリアス情報

- ENTRY:
  EXPLAIN: DeleteAlias
  BODY: |
    ■ 概要

    ・指定したエイリアスを削除する SDK メソッド
    ・関数やバージョンは削除されず、エイリアス名だけがなくなる
    ・DeleteAliasCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・不要になったエイリアス (例: 旧 staging) を整理する
    ・トラフィック分割をやめ、単一バージョン参照に戻す前に一時エイリアスを削除する

    ■ サンプル

      const { LambdaClient, DeleteAliasCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new DeleteAliasCommand({
        FunctionName:  'my-function',
        Name:          'staging',
      });

      await client.send(command);
      // 成功時は戻り値なし (204)

    ■ 引数(必須)

    ・FunctionName: string           対象の関数名、ARN、または部分 ARN
    ・Name: string                   削除するエイリアス名

    ■ 戻り値

    ・成功時は body なし (204)
    ・失敗時は ResourceNotFoundException 等

- ENTRY:
  EXPLAIN: ListAliases
  BODY: |
    ■ 概要

    ・指定した関数のエイリアス一覧を取得する SDK メソッド
    ・各エイリアスの名前、参照バージョン、説明、トラフィック分割設定等を取得できる
    ・ListAliasesCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・関数に紐づくエイリアスを一覧で確認する
    ・エイリアス名や参照バージョンを取得し、Invoke の Qualifier や設定の検証に使う

    ■ サンプル

      const { LambdaClient, ListAliasesCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new ListAliasesCommand({
        FunctionName: 'my-function',
        // FunctionVersion: '1',  // 指定バージョンを参照するエイリアスのみ
        // MaxItems: 50,
        // Marker: '...',
      });

      const result = await client.send(command);
      // result.Aliases => エイリアス情報の配列
      // result.NextMarker => 次ページがある場合に設定

    ■ 引数(必須)

    ・FunctionName: string           対象の関数名、ARN、または部分 ARN

    ■ 引数(任意)

    ・FunctionVersion: string        指定バージョンを参照するエイリアスのみに絞る
    ・MaxItems: number               取得する最大件数
    ・Marker: string                 ページネーション。前回の NextMarker を渡す

    ■ 戻り値

    ・Aliases: array                 エイリアス情報の配列 (AliasArn, Name, FunctionVersion, Description, RoutingConfig 等)
    ・NextMarker: string             次ページがある場合に設定

- ENTRY:
  EXPLAIN: AddPermission
  BODY: |
    ■ 概要

    ・関数のリソースベースポリシーに「誰が Invoke してよいか」を追加する SDK メソッド
    ・API Gateway、S3、EventBridge、SQS、他アカウント等、Principal を指定して呼び出しを許可する
    ・AddPermissionCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・API Gateway や S3 等のトリガーから関数を呼べるようにする
    ・他アカウントや特定 IAM ロールに Invoke を許可する
    ・SourceArn で呼び出し元を制限し、最小権限にする

    ■ サンプル

      const { LambdaClient, AddPermissionCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new AddPermissionCommand({
        FunctionName: 'my-function',
        StatementId:  'AllowAPIGateway',
        Action:        'lambda:InvokeFunction',
        Principal:     'apigateway.amazonaws.com',
        // SourceArn: 'arn:aws:execute-api:ap-northeast-1:123456789012:xxx/*',
        // Qualifier: 'prod',
      });

      const result = await client.send(command);
      // result.Statement => 追加されたポリシーステートメントの JSON

    ■ 引数(必須)

    ・FunctionName: string           対象の関数名、ARN、または部分 ARN
    ・StatementId: string           ポリシー内の一意 ID。削除時 (RemovePermission) に同じ ID を指定
    ・Action: string                 許可する操作。通常 lambda:InvokeFunction
    ・Principal: string              許可する主体。サービス (apigateway.amazonaws.com 等)、IAM ARN、アカウント ID 等

    ■ 引数(任意)

    ・SourceArn: string              呼び出し元の ARN に制限する場合
    ・SourceAccount: string         呼び出し元アカウント ID に制限する場合
    ・Qualifier: string              バージョンまたはエイリアスにのみ付与する場合

    ■ 戻り値

    ・Statement: string              追加されたステートメントの JSON

- ENTRY:
  EXPLAIN: RemovePermission
  BODY: |
    ■ 概要

    ・関数のリソースベースポリシーから、指定した StatementId の許可を削除する SDK メソッド
    ・AddPermission で付与した StatementId を指定して削除する
    ・RemovePermissionCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・API Gateway や S3 等のトリガー連携をやめる
    ・不要な呼び出し許可を削除してセキュリティを絞る

    ■ サンプル

      const { LambdaClient, RemovePermissionCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new RemovePermissionCommand({
        FunctionName: 'my-function',
        StatementId:  'AllowAPIGateway',
        // Qualifier: 'prod',
      });

      await client.send(command);
      // 成功時は戻り値なし

    ■ 引数(必須)

    ・FunctionName: string           対象の関数名、ARN、または部分 ARN
    ・StatementId: string            AddPermission で付けた一意 ID

    ■ 引数(任意)

    ・Qualifier: string              バージョンまたはエイリアスに付与した許可を削除する場合

    ■ 戻り値

    ・成功時は body なし。失敗時は ResourceNotFoundException 等

- ENTRY:
  EXPLAIN: GetPolicy
  BODY: |
    ■ 概要

    ・関数に設定されているリソースベースポリシー (JSON) を取得する SDK メソッド
    ・IAM 実行ロールのポリシーは取得できず、呼び出し許可 (AddPermission で追加したもの) のみ
    ・GetPolicyCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・誰が Invoke できるか確認する
    ・IaC や監査でポリシー内容を検証する
    ・トラブルシューティングで許可設定を確認する

    ■ サンプル

      const { LambdaClient, GetPolicyCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new GetPolicyCommand({
        FunctionName: 'my-function',
        // Qualifier: 'prod',
      });

      const result = await client.send(command);
      const policy = JSON.parse(result.Policy);

    ■ 引数(必須)

    ・FunctionName: string           対象の関数名、ARN、または部分 ARN

    ■ 引数(任意)

    ・Qualifier: string              バージョンまたはエイリアスに紐づくポリシーを取得する場合

    ■ 戻り値

    ・Policy: string                 リソースベースポリシーの JSON 文字列。パースして Statement 等を参照
    ・リソースポリシーが未設定の場合は ResourceNotFoundException

- ENTRY:
  EXPLAIN: TagResource
  BODY: |
    ■ 概要

    ・関数またはエイリアスにタグ (キー/値) を追加する SDK メソッド
    ・既存タグに同じキーがある場合は上書き。コスト配分、環境識別、検索に利用する
    ・TagResourceCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・環境 (Environment: prod)、コスト配分 (CostCenter: xxx)、プロジェクト名等を付与する
    ・ListTags やコンソールでタグによるフィルタ・検索に使う

    ■ サンプル

      const { LambdaClient, TagResourceCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new TagResourceCommand({
        Resource: 'arn:aws:lambda:ap-northeast-1:123456789012:function:my-function',
        Tags:     { Environment: 'prod', CostCenter: 'team-a' },
      });

      await client.send(command);
      // 成功時は戻り値なし

    ■ 引数(必須)

    ・Resource: string               関数またはエイリアスの ARN
    ・Tags: object                   キー/値のタグ。キーは 1〜128 文字、値は 0〜256 文字

    ■ 戻り値

    ・成功時は body なし

- ENTRY:
  EXPLAIN: UntagResource
  BODY: |
    ■ 概要

    ・関数またはエイリアスから指定したタグキーを削除する SDK メソッド
    ・TagKeys で列挙したキーだけ削除され、他タグは残る
    ・UntagResourceCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・不要になったタグを外す
    ・環境移行後に古いタグを削除する

    ■ サンプル

      const { LambdaClient, UntagResourceCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new UntagResourceCommand({
        Resource: 'arn:aws:lambda:ap-northeast-1:123456789012:function:my-function',
        TagKeys:  ['CostCenter', 'OldTag'],
      });

      await client.send(command);
      // 成功時は戻り値なし

    ■ 引数(必須)

    ・Resource: string               関数またはエイリアスの ARN
    ・TagKeys: string[]              削除するタグのキー配列

    ■ 戻り値

    ・成功時は body なし

- ENTRY:
  EXPLAIN: ListVersionsByFunction
  BODY: |
    ■ 概要

    ・指定した関数のバージョン一覧を取得する SDK メソッド
    ・$LATEST と発行済みバージョン (1, 2, ...) のメタデータを取得できる
    ・ListVersionsByFunctionCommand を LambdaClient に渡して実行する

    ■ ユースケース

    ・関数の全バージョンを一覧し、エイリアスの参照先候補やロールバック先を確認する
    ・最新バージョン番号を取得して PublishVersion 後の検証に使う

    ■ サンプル

      const { LambdaClient, ListVersionsByFunctionCommand } = require('@aws-sdk/client-lambda');

      const client = new LambdaClient({ region: 'ap-northeast-1' });

      const command = new ListVersionsByFunctionCommand({
        FunctionName: 'my-function',
        // MaxItems: 50,
        // Marker: '...',
      });

      const result = await client.send(command);
      // result.Versions => FunctionConfiguration の配列
      // result.NextMarker => 次ページがある場合に設定

    ■ 引数(必須)

    ・FunctionName: string           対象の関数名、ARN、または部分 ARN

    ■ 引数(任意)

    ・MaxItems: number               取得する最大件数
    ・Marker: string                 ページネーション。前回の NextMarker を渡す

    ■ 戻り値

    ・Versions: array                FunctionConfiguration の配列 ($LATEST と発行済みバージョン)
    ・NextMarker: string             次ページがある場合に設定
