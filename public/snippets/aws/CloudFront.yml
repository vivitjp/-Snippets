---
#-------------------------------
# CloudFront
#-------------------------------
- ENTRY:
  CATEGORY: CloudFront

- ENTRY:
  EXPLAIN: 概要、設定、コード
  BODY: |
    ■ 概要

      ・AWSのCDN(コンテンツ配信ネットワーク)サービス
      ・グローバルに分散したエッジロケーションを利用して、低遅延でコンテンツ配信
      ・静的・動的コンテンツ、動画ストリーミング、API配信などに対応
      ・S3、EC2、Lambda@Edge、オンプレミスサーバーなどをオリジンとして利用可能
      ・HTTPS対応、DDoS対策、WAF連携などのセキュリティ機能も提供

      ・CloudFrontは主に設定ベースのサービス、動的処理が必要な場合にコードを書く機会あり

    ■ S3でのHP公開との違い

      ・S3はオブジェクトストレージで、静的ウェブサイトホスティングが可能
      ・CloudFrontはCDNで、グローバルに分散したエッジロケーションからコンテンツを配信
      ・CloudFrontをS3の前に配置することで、キャッシュによる高速配信、セキュリティ強化、カスタムドメイン利用が可能

      ※ ウェブサイトホスティング
        ・静的 (S3 + CloudFront): SSG, ISR。ビルド済みHTMLを配信。高速・低コスト。
        ・動的 (EC2, Lambda, etc.): SSR, CSR。サーバー処理が必要。柔軟だがコスト高め。

        ※ CloudFrontは静的/動的両方に対応。キャッシュでパフォーマンス向上。

- ENTRY:
  EXPLAIN: 動的処理も可能
  BODY: |
    ■ Lambda@Edge

      ・CloudFrontのエッジロケーションで実行されるサーバーレス関数
      ・リクエスト/レスポンスのカスタマイズ（ヘッダー追加、リダイレクト、認証など）
      ・Node.jsで記述、CloudFrontイベント（Viewer Request/Response, Origin Request/Response）でトリガー
      ・例: 地理情報に基づくコンテンツ配信、A/Bテスト、セキュリティ強化

    ■ CloudFront Functions

      ・軽量なJavaScript関数で、ビューワーリクエスト/レスポンスを処理
      ・Lambda@Edgeより高速・低コストだが、機能は限定的
      ・例: URLリライト、ヘッダー操作、アクセス制御

    ■ SDK/APIを使用したプログラム管理

      ・CloudFrontディストリビューションの作成/更新/削除をコードで自動化
      ・AWS SDK (JavaScript, Python, etc.) を使用
      ・Infrastructure as Code (CloudFormation, CDK) で設定管理

    ■ オリジンのコード

      ・バックエンド（EC2, Lambda, API Gateway）の実装
      ・CloudFrontはキャッシュ/配信レイヤーなので、オリジンのロジックは別途実装

- ENTRY:
  CATEGORY: WebHosting

- ENTRY:
  EXPLAIN: 静的Webサイト配信構成例
  BODY: |
    ■ 構成
                       ┌───────────────────────────┐
                       │ AWS                       │
                       │  ┌────────────┐  ┌──────┐ │
    User ── Internet ──┼──┤ CloudFront ├──┤  S3  │ │
                       │  │   (CDN)    │  │      │ │
                       │  └────────────┘  └──────┘ │
                       └───────────────────────────┘

    ■ CloudFrontとS3の間の通信

      ・HTTPSで暗号化
      ・CloudFrontからS3バケットにアクセス: OAC利用
      ・S3fがCloudFrontからのアクセスを許可: バケットポリシー

- ENTRY:
  EXPLAIN: OAC(Origin Access Control)作成
  BODY: |
    ■ 概要

    ・CloudFrontがS3オリジンにアクセスする際の認証と制御を行う機能
    ・OACを使用することで、S3バケットをパブリックにすることなく、CloudFront経由でのアクセスを許可可能
    ・OACは署名付きリクエストを生成し、CloudFrontがS3にアクセスする際に使用

    ■ 作成手順

    ・ダッシュボードから[CloudFront]を選択
    ・メニューから[オリジンアクセス]を選択
    ・[コントロール設定を作成]をクリック

    ■ コントロール設定の作成

      ・名前: OACの名前を指定
      ・署名動作
        ・[リクエストに署名しない]
        ・[署名リクエスト(推奨)]を選択
          ・署名の有効期限: 1時間(3600秒)
          ・認証ヘッダを上書きしない: OFF
      ・オリジンタイプ
        ・[S3]を選択

- ENTRY:
  EXPLAIN: CloudFront「ディストリビューション」
  BODY: |
    ■ 概要

    ・CloudFrontの配信設定単位
    ・オリジン、キャッシュビヘイビア、SSL設定、WAF連携などを含む
    ・ディストリビューションごとに独立した設定が可能

    ■ 作成手順

    ・ダッシュボードから[CloudFront]を選択
    ・メニューから[ディストリビューション]を選択
    ・[ディストリビューションの作成]をクリック

    ■ [画面]ディストリビューションを作成

      ・オリジンドメイン
        ・作成したS3のバケット名を含むドメイン名
      ・オリジンパス・オプション
      ・名前
        ・オリジンドメイン名を指定(同じでよい)
      ・オリジンアクセス
        ・[Public] 
        ・[Origin Access Control settings](推奨)を選択
        ・[Legacy Access Identity]

    ■ デフォルトのキャッシュビヘイビア

      ・パスパターン
        ・デフォルト(*)
      ・オブジェクトを自動的に圧縮
        ・Yes 選択
      ・ビューワー
        ・ビューワープロトコルポリシー  
          ・HTTP to HTTPS
          ・Redirect HTTP to HTTPS
          ・HTTPS only
      ・許可された HTTPメソッド
        ・GET, HEAD
        ・GET, HEAD, OPTIONS
        ・GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE
      ・WAF(Web Application Firewall)
        ・[セキュリティ保護を有効にする] <=ランディングページなた必要
        ・[セキュリティ保護を有効にしない]

    ■ 画面 [新しいディストリビューションが正常に作成されました]

      [S3バケットポリシーを更新する必要があります]
      ・[ポリシーをコピー]をクリック
      {
        "Version": "2008-10-17",
        "Id": "PolicyForCloudFrontPrivateContent",
        "Statement": [
          {
            "Sid": "AllowCloudFrontServicePrincipal",
            "Effect": "Allow",
            "Principal": {
              "Service": "cloudfront.amazonaws.com"
            },
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::20231210tekitobucket--us-west-2/*",
            "Condition": {
              "StringEquals": {
                "AWS:SourceArn": "arn:aws:cloudfront::YOUR_ACCOUNT_ID:distribution/ENW7MC67VLORD"
              }
            }
          }
        ]
      }

- ENTRY:
  EXPLAIN: S3バケットポリシー
  BODY: |
    ■ 概要

    ・S3バケットにcloudfrontのアクセスを許可
    ・OACを使用する場合、バケットポリシーでCloudFrontのサービスプリンシパルにGetObject権限を付与

    ■ 更新手順

    ・ダッシュボードから[S3]を選択
    ・メニューから[バケット]を選択
    ・バケット名をクリック
    ・[アクセス許可]をクリック
    ・[バケットポリシー]をクリック
    ・[編集]をクリック
    ・コピーしたポリシーを貼り付けて、[保存]をクリック

- ENTRY:
  EXPLAIN: indexページ作成
  BODY: |
    ■ ダッシュボードから[S3]を選択
      ・メニューから[バケット]を選択
      ・バケット名をクリック
      ・[オブジェクト]をクリック
      ・[アップロード]をクリック
      ・[ファイルの追加]をクリック
      ・index.htmlを選択して、[アップロード]をクリック

    ■ アクセス
      例: https://<ID>.cloudfront.net/index.html

- ENTRY:
  EXPLAIN: 「罠」
  BODY: |
    ■ httpでしかアクセスできない
      ・CloudFrontを使うことで、HTTPSでアクセス可能
      ・S3バケットはHTTPでしかアクセスできない
      ・CloudFront←→S3の通信はHTTP

    ■ バケットを公開しなければならない
      ・バケットの公開が必須(公式仕様)
