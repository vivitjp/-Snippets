---
#-------------------------------
# Amplify
#-------------------------------
- KEY: aws.Amplify.category
  CATEGORY: 概説

- KEY: aws.Amplify.概説
  EXPLAIN: 概説
  BODY: |
    Aall-in-one:
      CloudFront
      S3
      AppSync
      DynamoDB

    対応:
      JS(React,Angular,Vue)
      Mac
      Android

    Web Document
      https://docs.amplify.aws/react/

    ■ AWS Amplifyでできること

      認証機能:  Cognitoを利用したサインアップ・サインイン機能を数行で実装
      API構築:  GraphQL (AWS AppSync) または REST (API Gateway+Lambda) でAPI構築、FEからアクセス
      データストア:  オフラインファーストでデータを同期する機能を提供し、リアルタイム通信もサポート
      ストレージ:  ユーザー認証に基づいたファイルアップロード・ダウンロード機能（Amazon S3利用）実装
      ホスティングとCI/CD:  Git連携による自動デプロイとHTTPS対応の安全なウェブホスティング

    ■ Amplify Framework:

      React、Vue、Angular、iOS、Androidなどに対応したクライアントライブラリとUIコンポーネントのセット
      認証、API接続、データストア、ストレージなどBEとの連携処理をフロントエンドコード内に記述

    ■ Amplify CLI (Command Line Interface):

      AWS上でサーバーレスなBE（Lambda、API Gateway、DynamoDB、S3など）を構築管理する対話型CLI

    ■ Amplify Hosting & Console / Admin UI:

      FEのコード（Gitリポジトリ）と連携、ビルド、ホスティング、CI/CDパイプラインを自動化
      ブランチごとにテスト環境を自動構築、GUIでモデル定義、コンテンツ、ユーザー管理UI

- KEY: aws.Amplify.install
  EXPLAIN: インストール
  BODY: |
    ■ Backend: Amplify CLI のインストール

      ・Node.js と npm がインストールされていることを確認
      ・以下コマンドでAmplify CLIをグローバルインストール

      > npm install -g @aws-amplify/cli

      ・インストール確認

      > amplify --version

    ■ AWS CLI のインストール（必要に応じて）

      ・Amplify CLIはAWSリソースを操作するため、AWS CLIも必要になる場合がある
      ・AWS CLIが未インストールの場合、以下手順でインストール

      [Mac/Linux]
      > curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
      > sudo installer -pkg AWSCLIV2.pkg -target /

      [Windows]
      ・公式サイトからインストーラーをダウンロードし、ウィザードに従ってインストール

      ・インストール確認

      > aws --version

    ■ Frontend: Amplify Framework のインストール

      ・フロントエンドプロジェクトのルートディレクトリで以下コマンドを実行し、Amplifyライブラリをインストール

      > npm install aws-amplify

    ■ React Native

      > npm install aws-amplify @react-native-async-storage/async-storage

- KEY: aws.Amplify.pull_push.category
  CATEGORY: 同期(pull/push)

- KEY: aws.Amplify.pull
  EXPLAIN: pull
  BODY: |
    ■ チーム開発でのバックエンド同期 

      ・複数開発者が同じAmplifyプロジェクトのBE（認証設定、API定義、データベーススキーマなど）を変更
      ・git pullなどで最新のBE設定がローカルに取得された後、amplify pull を実行
      ・他のチームメンバーがクラウドにプッシュした最新のBE変更を、自分のローカル環境に反映
          .amplify/
          クライアント設定ファイル
            aws-exports.js
            amplifyconfiguration.json

    ■ 既存のバックエンドへの接続・初期化

      ・新しいFEプロジェクトのリポジトリから、すでに存在するAmplifyバックエンド環境に接続する際に使用
      ・新プロジェクトで以下実行
        
          amplify pull --appId <YOUR_APP_ID> --envName <YOUR_ENV_NAME>

      ・そのプロジェクトがAmplify CLIで初期化され、指定されたクラウドのバックエンド情報がローカルにダウンロード
      ・Amplify Studio（Web管理画面）で加えた変更をCLI環境に反映させたい場合にも利用

    ■ 変更検知

      ・定期的に手動で amplify pull を実行する必要なし
      ・Amplify CLIは、クラウド変更を自動検知
      ・amplify push 実行時、他の更新が先にクラウドにプッシュされていた場合、CLIは「クラウド環境が最新の状態ではない」ことを検知
      ・その場合、CLIは amplify push を実行する前に、エラーメッセージや警告を表示
        「クラウドの変更を取得するために amplify pull を実行してください」
      ・通常のチーム開発のベストプラクティスとしては、Gitの運用と合わせて以下のようにするのが一般的
      ・作業開始時: git pull で最新のコードを取得。
      ・もし他のメンバーがBEも更新していた場合、以下に変更が含まれている
          .amplify/
          aws-exports.js
          amplifyconfiguration.json     // または

      ・バックエンドの競合解決:
        もし git pull で .amplify にコンフリクトが発生した場合、まずはGitで競合を解決
        その後、念のために amplify pull を実行、ローカルの状態をクラウドと完全同期

- KEY: aws.Amplify.push
  EXPLAIN: push
  BODY: |
    ■ バックエンド変更のクラウド反映

      ・ローカル開発環境で加えたAWS Amplifyバックエンドの設定変更を、AWSクラウド上の環境に反映
      ・Gitにおける git push に似ている（コードではなくインフラの変更をクラウドにアップロード）

    ■ 1.変更の検出:

      ・ローカルの .amplify/ から GraphQLスキーマ、認証ルール、Lambda関数のコードなどを読み込み、変更点検出

    ■ 2.AWS CloudFormation スタックの更新

      ・AmplifyはAWSのサービスを「AWS CloudFormation」という仕組みを使って管理
      ・CloudFormationは、AWSリソースを一括で定義・作成・更新できるサービス
      ・amplify push は、ローカル変更を基にCloudFormationのテンプレートを生成・更新、クラウド環境に適用

    ■ 3.リソースのプロビジョニング（作成・更新）

      ・CloudFormationがAWSの各サービス（S3、DynamoDB、Cognito、Lambdaなど）と通信
      ・データベースの新規作成、APIの更新、認証設定の変更といったデプロイ実施

    ■ 4.クライアント設定ファイルの更新

      ・デプロイが完了すると、クラウド上のリソースのエンドポイント（接続先URLなど）の情報が確定
      ・CLIは、その最新情報を含む設定ファイルを自動更新
          FEプロジェクト内の aws-exports.js や amplifyconfiguration.json

    ■ amplify push を実行するタイミング

      ・バックエンド変更:
          amplify add auth (認証機能の追加)
          amplify update api (GraphQLスキーマの変更など)
          Lambda関数のコード修正

- KEY: aws.Amplify.flow.category
  CATEGORY: 開発フロー

- KEY: aws.Amplify.backend
  EXPLAIN: バックエンド
  BODY: |
    ■ ローカル端末にAmplify CLI のインストール

      > npm install -g @aws-amplify/cli
      > amplify --version

    ■ 設定: Amplify CLI の初期セットアップ
      使用リージョン、クレデンシャル、プロファイル情報の設定

      > amplify configure

    ■ プロジェクトのルートディレクトリで初期化コマンドを実⾏

      > amplify init

      ・プロジェクト名
      ・環境名(production/staging/develop/test ..etc)
      ・使⽤するプラットーフォーム(プログラム⾔語/フレームワーク)
      ・プロジェクトが使⽤するプロファイル情報
      ・使⽤するエディタ
      ・プロジェクトのディレクトリ情報..等

      Specify the AWS Region
      ? region:  ap-northeast-1
      Specify the username of the new IAM user:
      ? user name:  amplify-8ZcOy
      Complete the user creation using the AWS console
      https://console.aws.amazon.com/iam/home?region=undefined#/users$new?step=final&
      accessKey&userNames=amplify-8ZcOy&permissionType=policies&
      policies=arn:aws:iam::aws:policy%2FAdministratorAccess
      Press Enter to continue

      [Browser] ウィザード形式の IAMユーザー 追加ページが表示

        アクセスの種類: プログラムによるアクセス
        アクセス許可の設定
        タグの追加(オプション)
          -> ユーザーの作成
          ユーザ名、アクセスキーID、シークレットアクセスキー

      [CLI] に戻る
      Enter the access key of the newly created user:
      ? accessKeyId:  XXXXXXXXXXXX**********
      ? secretAccessKey:  XXXXXXXXXXXXXXXXXXXX********************
      This would update/create the AWS Profile in your local machine
      ? Profile Name:  amplify-8ZcOy

      Successfully set up the new user. <- 設定完了

      > aws configure list --profile amplify-8ZcOy

            Name                    Value             Type    Location
            ----                    -----             ----    --------
        profile            amplify-8ZcOy           manual    --profile
      access_key     ****************XXXX shared-credentials-file
      secret_key     ****************XXXX shared-credentials-file
          region           ap-northeast-1      config-file    ~/.aws/config

    ■ コマンド完了後、ルートディレクトリに /amplify 作成される

      /amplify
      /node_modules
      /public
      /src
      .dot files
      package.json

    ■ バックエンドの設定追加（対話）

      > amplify add <カテゴリ名>
      > amplify add api                 // api 構築

        ・api カテゴリの設定項⽬の例
        ・REST API or GraphQL ?
        ・API のスキーマ
        ・パブリックに公開するAPI か︖認証が必要なAPI か︖..等

    ■ 既存カテゴリの更新、削除

      > amplify update <カテゴリ名>
      > amplify remove <カテゴリ名>

    ■ ステータス

      > amplify status

        Current Environment: dev
        | Category | Resource name | Operation | Provider plugin   |
        | -------- | ------------- | --------- | ----------------- |
        | Storage  | s4354vdcs...  | Create    | awscloudformation | <-- 未反映
        | Api      | blackbelt     | Update    | awscloudformation | <-- 未反映
        | Auth     | gbsjfjfldk..  | No Change | awscloudformation |

    ■ 反映
    add/update/remove コマンド実行後、設定をバックエンドに反映させる必要あり

    > amplify push

      バックエンド反映後に、エンドポイントの設定ファイルが出⼒される
      アプリケーションはこの設定ファイルを読み込んでバックエンドに接続する

      /aws-exports.js

- KEY: aws.Amplify.frontend
  EXPLAIN: フロントエンド
  BODY: |
    Amplify Framework でApplication実装
    > npm install aws-amplify

    ■ (OLD) コードをコピー＆ペース、npm installで依存パッケージ
    demo-amplify-js-app
      /src
         /app.js
      index.html
      package.json
      webpack.config.js

    npm start
    http://localhost:8080

    ■ 初期化
    > amplify init

      Note: It is recommended to run this command from the root of your app directory
      ? Enter a name for the project: demo-amplify-js-app
      ? Enter a name for the environment: prod
      ? Choose your default editor: Visual Studio Code
      ? Choose the type of app that you're building javascript
      Please tell us about your project
      ? What javascript framework are you using: none
      ? Source Directory Path: src
      ? Distribution Directory Path: dist
      ? Build Command:  npm.cmd run-script build
      ? Start Command: npm.cmd run-script start
      Using default provider  awscloudformation

      For more information on AWS Profiles, see:
      https://docs.aws.amazon.com/cli/latest/userguide/cli-multiple-profiles.html

      ? Do you want to use an AWS profile? Yes
      ? Please choose the profile you want to use amplify-8ZcOy
      Adding backend environment dev to AWS Amplify Console app: xxxxxxxxxxxxxx
      - Initializing project in the cloud...

      // 省略

      Your project has been successfully initialized and connected to the cloud!

      Some next steps:
      "amplify status" will show you what you've added already and if it's locally configured or deployed
      "amplify add <category>" will allow you to add features like user login or a backend API
      "amplify push" will build all your local backend resources and provision it in the cloud
      “amplify console” to open the Amplify Console and view your project status
      "amplify publish" will build all your local backend and frontend resources
          (if you have hosting category added) and provision it in the cloud

      Pro tip:
      Try "amplify add api" to create a backend API and then "amplify publish" to deploy everything

    ■ initで作成されるAWSのリソース

      Amplify Console       demo-amplify-js-app                                 アプリケーション作成
      CloudFormation        amplify-demo-amplify-js-app-prod-213624             Stack作成
      S3                    amplify-demo-amplify-js-app-prod-213624-deployment  デプロイ用バケット作成
      Roles                 amplify-demo-amplify-js-app-prod-213624-authRole    ロール
                            amplify-demo-amplify-js-app-prod-213624-unauthRole

    ■ init後のプロジェクト

      demo-amplify-js-app
        /amplify                        <--- add
          /.config
            local-aws-info.json
            local-env-info.json
            project-config.json
          /#current-cloud-backend
            amplify-meta.json
          /backend
            amplify-meta.json
            backend-config.json
          teram-provider-info.json
        /dist
        /node_modules
        /src
          app.js
          aws-exports.js                <--- add
        .gitignore                      <--- add
        index.html
        package.json
        package-lock.json
        webpack.config.js

    ■ プロジェクトのgit管理(.gitignore)

      # amplify
      amplify/\#current-cloud-backend
      amplify/.config/local-*
      amplify/mock-data
      amplify/backend/amplify-meta.json
      amplify/backend/awscloudformation
      build/
      dist/
      node_modules/
      aws-exports.js
      awsconfiguration.json
      amplifyconfiguration.json
      amplify-build-config.json
      amplify-gradle-config.json
      amplifyxc.config

    ■ add api 作成後のプロジェクト

      demo-amplify-js-app
      /amplify
        /.config
          local-aws-info.json
          local-env-info.json
          project-config.json
        /#current-cloud-backend
          amplify-meta.json
        /backend
          ---------------------------------ここが追加される
          /api                          <--- add
            /todo                       <--- amplify add apiで指定したAPI名
              /build
              /resolvers
              /stacks
                CustomResources.json
              parameters.json
              schema.graphql            <--- GraphQLのスキーマファイル 
              transform.config.json
          ---------------------------------
          amplify-meta.json
          backend-config.json           <--- modify
        teram-provider-info.json
      /dist
      /node_modules
      ...
