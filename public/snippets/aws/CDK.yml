---
#-------------------------------
# CDK
#-------------------------------
- ENTRY:
  CATEGORY: æ¦‚è¦

- ENTRY:
  EXPLAIN: |
    æ¦‚è¦
  BODY: |
    â€¢ AWS CloudFormationã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã‚‚ã®
    â€¢ Lambdaã€VPCã€S3ãªã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’Pythonãªã©ã§å®šç¾©ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆ
    â€¢ AWS CDK ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®å®šç¾©
    â€¢ å®Ÿè¡Œã™ã‚‹ã¨å®šç¾©å„ã‚¹ã‚¿ãƒƒã‚¯ã«å¯¾ã— AWS CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹
      â€» CDK ã®ç”¨èªã§ã¯ã€Œsynthesize=åˆæˆã€

- ENTRY:
  CATEGORY: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—: Hello

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 1.åˆæœŸåŒ–
  BODY: |
    â–  ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ

    > mkdir cdk-workshop && cd cdk-workshop

    â–  åˆæœŸåŒ–(TypeScript)

    > cdk init sample-app --language typescript

    Applying project template sample-app for typescript

    # Welcome to your CDK TypeScript project

    You should explore the contents of this project. It demonstrates a CDK app with an instance of a stack (`CdkWorkshopStack`)
    which contains an Amazon SQS queue that is subscribed to an Amazon SNS topic.

    The `cdk.json` file tells the CDK Toolkit how to execute your app.

    ## Useful commands

    * `npm run build`   compile typescript to js
    * `npm run watch`   watch for changes and compile
    * `npm run test`    perform the jest unit tests
    * `cdk deploy`      deploy this stack to your default AWS account/region
    * `cdk diff`        compare deployed stack with current state
    * `cdk synth`       emits the synthesized CloudFormation template

    â–  ç”Ÿæˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

    /bin
      â””â”€â”€ cdk-workshop.ts             // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
    /lib
      â””â”€â”€ cdk-workshop-stack.ts       // ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¿ãƒƒã‚¯å®šç¾©(ä½œæ¥­ã¯ã»ã¼ã“ã“)
    /node_modules
    /test
      â””â”€â”€ cdk-workshop.test.ts
    cdk.json                          // å®Ÿè¡Œæ–¹æ³•ã‚’ AWS CDK Toolkit ã«æŒ‡ç¤º
                                      // "npx ts-node bin/cdk-workshop.ts"
    package.json  
    tsconfig.json

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 2.ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
  BODY: |
    â–  ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ: bin/cdk-workshop.ts

    #!/usr/bin/env node
    import * as cdk from 'aws-cdk-lib'
    import { CdkWorkshopStack } from '../lib/cdk-workshop-stack'

    const app = new cdk.App()
    new CdkWorkshopStack(app, 'CdkWorkshopStack')

    â–  ãƒ¡ã‚¤ãƒ³ã®ã‚¹ã‚¿ãƒƒã‚¯: lib/cdk-workshop-stack.ts

    import { Duration, Stack, StackProps } from 'aws-cdk-lib';
    import * as sns from 'aws-cdk-lib/aws-sns';
    import * as subs from 'aws-cdk-lib/aws-sns-subscriptions';
    import * as sqs from 'aws-cdk-lib/aws-sqs';
    import { Construct } from 'constructs';

    export class CdkWorkshopStack extends Stack {
      constructor(scope: Construct, id: string, props?: StackProps) {
        super(scope, id, props);

        // SQS ã‚­ãƒ¥ãƒ¼ ã‚µãƒ³ãƒ—ãƒ«
        const queue = new sqs.Queue(this, 'CdkWorkshopQueue', {
          visibilityTimeout: Duration.seconds(300)
        });

        // SNS ãƒˆãƒ”ãƒƒã‚¯ ã‚µãƒ³ãƒ—ãƒ«
        const topic = new sns.Topic(this, 'CdkWorkshopTopic');

        // ãƒˆãƒ”ãƒƒã‚¯ã¸ã®ç™ºè¡Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã®ãŸã‚ã«ã‚­ãƒ¥ãƒ¼ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–
        topic.addSubscription(new subs.SqsSubscription(queue));
      }
    }

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 3.ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆæˆã¨ç”Ÿæˆçµæœ
  BODY: |
    â–  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆæˆ

    cdk.json ã¨åŒã˜DIRã«ç§»å‹•
    > cdk synth

    â–  åˆæˆã•ã‚ŒãŸ CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

    Resources:
      // ãƒªã‚½ãƒ¼ã‚¹å®šç¾©: SQS(Queue)
      CdkWorkshopQueue50D9D426:
        Type: AWS::SQS::Queue
        Properties:
          VisibilityTimeout: 300
        UpdateReplacePolicy: Delete
        DeletionPolicy: Delete
        Metadata:
          aws:cdk:path: CdkWorkshopStack/CdkWorkshopQueue/Resource

      // ãƒªã‚½ãƒ¼ã‚¹å®šç¾©: SQS(QueuePolicy)
      CdkWorkshopQueuePolicyAF2494A5:
        Type: AWS::SQS::QueuePolicy
        Properties:
          PolicyDocument:
            Statement:
              - Action: sqs:SendMessage
                Condition:
                  ArnEquals:
                    aws:SourceArn:
                      Ref: CdkWorkshopTopicD368A42F
                Effect: Allow
                Principal:
                  Service: sns.amazonaws.com
                Resource:
                  Fn::GetAtt:
                    - CdkWorkshopQueue50D9D426
                    - Arn
            Version: "2012-10-17"
          Queues:
            - Ref: CdkWorkshopQueue50D9D426
        Metadata:
          aws:cdk:path: CdkWorkshopStack/CdkWorkshopQueue/Policy/Resource

      // ãƒªã‚½ãƒ¼ã‚¹å®šç¾©: SQS: Stack Subscription
      CdkWorkshopQueueCdkWorkshopStackCdkWorkshopTopicD7BE96438B5AD106:
        Type: AWS::SNS::Subscription
        Properties:
          Protocol: sqs
          TopicArn:
            Ref: CdkWorkshopTopicD368A42F
          Endpoint:
            Fn::GetAtt:
              - CdkWorkshopQueue50D9D426
              - Arn
        DependsOn:
          - CdkWorkshopQueuePolicyAF2494A5
        Metadata:
          aws:cdk:path: CdkWorkshopStack/CdkWorkshopQueue/CdkWorkshopStackCdkWorkshopTopicD7BE9643/Resource

      // ãƒªã‚½ãƒ¼ã‚¹å®šç¾©: SNS: Topic
      CdkWorkshopTopicD368A42F:
        Type: AWS::SNS::Topic
        Metadata:
          aws:cdk:path: CdkWorkshopStack/CdkWorkshopTopic/Resource

      // ãƒªã‚½ãƒ¼ã‚¹å®šç¾©: CDK: Metadata
      CDKMetadata:
        Type: AWS::CDK::Metadata
        Properties:
          Analytics: v2:deflate64:H4sIAAAAAAAA/1WO0QrCMAxFv8X3NjpBwe...w0ZX8B5//lbcEAAAA=
        Metadata:
          aws:cdk:path: CdkWorkshopStack/CDKMetadata/Default
        Condition: CDKMetadataAvailable

    // æ¡ä»¶
    Conditions:
      CDKMetadataAvailable:
        Fn::Or:
          - Fn::Or:
              - Fn::Equals:
                  - Ref: AWS::Region
                  - af-south-1
              - Fn::Equals:
                  - Ref: AWS::Region
                  - ap-east-1
              ...

    // å¼•æ•°
    Parameters:
      BootstrapVersion:
        Type: AWS::SSM::Parameter::Value<String>
        Default: /cdk-bootstrap/hnb659fds/version
        Description: Version of the CDK Bootstrap resources in this environment,
                     automatically retrieved from SSM Parameter Store. [cdk:skip]

    // ãƒ«ãƒ¼ãƒ«
    Rules:
      CheckBootstrapVersion:
        Assertions:
          - Assert:
              Fn::Not:
                - Fn::Contains:
                    - - "1"
                      - "2"
                      - "3"
                      - "4"
                      - "5"
                    - Ref: BootstrapVersion
            AssertDescription: CDK bootstrap stack version 6 required. 
                                Please run 'cdk bootstrap' with a recent version of the CDK CLI.

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 4.deploy
  BODY: |
    â–  ç’°å¢ƒã®ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—

    > cdk bootstrap

    Bootstrapping environment aws://123456789012/ap-northeast-1...
    âœ… Environment aws://123456789012/ap-northeast-1 bootstrapped.

    â–  ãƒ‡ãƒ—ãƒ­ã‚¤

    > cdk deploy

    â–  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£å¤‰æ›´ã®ç¢ºèª

    This deployment will make potentially sensitive changes according to your current security approval level (--require-approval broadening).
    Please confirm you intend to make the following modifications:

    IAM Statement Changes
    â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   â”‚ Resource                       â”‚ Effect â”‚ Action          â”‚ Principal                      â”‚ Condition                      â”‚
    â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ + â”‚ ${CdkWorkshopQueue.Arn}        â”‚ Allow  â”‚ sqs:SendMessage â”‚ Service:sns.amazonaws.com      â”‚ "ArnEquals": {                 â”‚
    â”‚   â”‚                                â”‚        â”‚                 â”‚                                â”‚   "aws:SourceArn": "${CdkWorks â”‚
    â”‚   â”‚                                â”‚        â”‚                 â”‚                                â”‚ hopTopic}"                     â”‚
    â”‚   â”‚                                â”‚        â”‚                 â”‚                                â”‚ }                              â”‚
    â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

    Do you wish to deploy these changes (y/n)?

    CdkWorkshopStack: deploying...
    CdkWorkshopStack: creating CloudFormation changeset...

    âœ…  CdkWorkshopStack

    Stack ARN:
    arn:aws:cloudformation:ap-northeast-1:123456789012:stack/CdkWorkshopStack/{STACK-ID}

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 5.ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
  BODY: |
    â–  ãƒãƒãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«

    cloudformation > Stacks 
    cloudformation > Stacks > CdkWorkshopStack

    ã€Œãƒªã‚½ãƒ¼ã‚¹ã€ã‚¿ãƒ–ã‚’é–‹ãã¨ã€å±•é–‹å¯èƒ½ãªãƒ„ãƒªãƒ¼å½¢å¼ã§ãƒªã‚½ãƒ¼ã‚¹ã®è«–ç† ID ãŒè¡¨ç¤ºã•ã‚Œã‚‹

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 6.ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  BODY: |
    â–  ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

    lib/cdk-workshop-stack.ts ã‚’é–‹ã„ã¦ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

    import { Stack, StackProps } from "aws-cdk-lib";
    import { Construct } from "constructs";

    export class CdkWorkshopStack extends Stack {
      constructor(scope: Construct, id: string, props?: StackProps) {
        super(scope, id, props);
      }
    }

    â–  å·®åˆ†è¡¨ç¤º

    > cdk diff

    Stack CdkWorkshopStack
    IAM Statement Changes
    â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   â”‚ Resource                        â”‚ Effect â”‚ Action          â”‚ Principal                 â”‚ Condition                                        â”‚
    â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ - â”‚ ${CdkWorkshopQueue50D9D426.Arn} â”‚ Allow  â”‚ sqs:SendMessage â”‚ Service:sns.amazonaws.com â”‚ "ArnEquals": {                                   â”‚
    â”‚   â”‚                                 â”‚        â”‚                 â”‚                           â”‚   "aws:SourceArn": "${CdkWorkshopTopicD368A42F}" â”‚
    â”‚   â”‚                                 â”‚        â”‚                 â”‚                           â”‚ }                                                â”‚
    â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

    Resources
    [-] AWS::SQS::Queue CdkWorkshopQueue50D9D426 destroy
    [-] AWS::SQS::QueuePolicy CdkWorkshopQueuePolicyAF2494A5 destroy
    [-] AWS::SNS::Topic CdkWorkshopTopicD368A42F destroy
    [-] AWS::SNS::Subscription CdkWorkshopTopicCdkWorkshopQueueSubscription88D211C7 destroy

    â–  cdk deploy ã®å®Ÿè¡Œ

    > cdk deploy

    æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«é€²ã‚€(å¾…ã¤å¿…è¦ãªã—)
      CdkWorkshopStack: deploying...
      CdkWorkshopStack: destroying CloudFormation changeset...

      âœ…  CdkWorkshopStack

      Stack ARN:
      arn:aws:cloudformation:ap-northeast-1:123456789012:stack/CdkWorkshopStack/{STACK-ID}

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 7.Lambdaä½œæˆ
  BODY: |
    â–  Lambda é–¢æ•°ã®ä½œæˆ

    â€¢ ãƒ«ãƒ¼ãƒˆ(bin,lib,...ã®éš£)ã« /lambda ä½œæˆ
    â€¢ cdk init ã§ä½œæˆã•ã‚ŒãŸ TS CDK ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã™ã¹ã¦ã® .js ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç„¡è¦–
      â€¢ .gitignore ãƒ•ã‚¡ã‚¤ãƒ«ã« !lambda/*.js è¿½åŠ 
      â€¢ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ Lambda ã‚¢ã‚»ãƒƒãƒˆæ¤œå‡º
    â€¢ /lambda ã« hello.js è¿½åŠ 
      â€¢ API Gateway ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã® HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆã«ä½¿ç”¨

      exports.handler = async function (event) {
        console.log('request:', JSON.stringify(event, undefined, 2))
        return {
          statusCode: 200,
          headers: { 'Content-Type': 'text/plain' },
          body: `Hello, CDK! You've hit ${event.path}\n`,
        }
      }

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 8.ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  BODY: |
    â–  ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª

    â€¢ AWS CDKã«ã¯ AWS Construct Libraryã¨å‘¼ã°ã‚Œã‚‹å¤§è¦æ¨¡ãªã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä»˜å±
    â€¢ ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ AWS ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«åˆ†å‰²
    â€¢ AWS Lambda é–¢æ•°å®šç¾©ã«ã¯ AWS Lambda ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 9.ã‚¹ã‚¿ãƒƒã‚¯ã«AWSLambdaé–¢æ•°è¿½åŠ 
  BODY: |
    â–  ã‚³ãƒ¼ãƒ‰ä¿®æ­£

    â€¢ lib/cdk-workshop-stack.ts ã®å…ˆé ­ã« import ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
    â€¢ ã‚¹ã‚¿ãƒƒã‚¯ã« lambda.Function è¿½åŠ 

      import { Stack, StackProps } from "aws-cdk-lib";
      import { Code, Function, Runtime } from "aws-cdk-lib/aws-lambda";
      import { Construct } from "constructs";

      export class CdkWorkshopStack extends Stack {
        constructor(scope: Construct, id: string, props?: StackProps) { <--- ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
          super(scope, id, props);

          const hello = new Function(this, "HelloHandler", {
            runtime: Runtime.NODEJS_22_X,         // å®Ÿè¡Œç’°å¢ƒ(Nodejs v22.x)
            code:    Code.fromAsset("lambda"),    // /lambda æŒ‡å®š(cdkã‚’å®Ÿè¡Œã™ã‚‹å ´æ‰€ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹)
            handler: "hello.handler",             // ãƒ•ã‚¡ã‚¤ãƒ«å: hello, ãƒ¡ã‚½ãƒƒãƒ‰: handler
          });
        }
      }

    â–  ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿

    â€¢ ã‚¯ãƒ©ã‚¹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯ã€(scope, id, props) ã¨ã„ã†ã‚·ã‚°ãƒãƒãƒ£ã‚’æŒã¤ CDK ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬æ§‹æˆè¦ç´ 
    â€¢ scope: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãŒä½œæˆã•ã‚Œã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ã€‚ ã»ã¨ã‚“ã©ã®å ´åˆå˜ã« this ã‚’æ¸¡ã™ã€‚
    â€¢ id:    ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã® ä¸€æ„ãªãƒ­ãƒ¼ã‚«ãƒ«IDã€‚ã‚¹ã‚³ãƒ¼ãƒ—å†…å®šç¾©ãƒªã‚½ãƒ¼ã‚¹ã® CloudFormation è«–ç† ID è¨ˆç®—ã«ä½¿ç”¨ã€‚
    â€¢ props: (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)åˆæœŸåŒ–ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€‚ä¾‹ï¼š runtimeã€codeã€handler ãªã©

    â–  ã‚³ãƒ¼ãƒ‰ä¿å­˜ & ç¢ºèª(cdk diff)

    Stack CdkWorkshopStack
    IAM Statement Changes
    â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   â”‚ Resource                        â”‚ Effect â”‚ Action         â”‚ Principal                    â”‚ Condition â”‚
    â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ + â”‚ ${HelloHandler/ServiceRole.Arn} â”‚ Allow  â”‚ sts:AssumeRole â”‚ Service:lambda.amazonaws.com â”‚           â”‚
    â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    IAM Policy Changes
    â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   â”‚ Resource                    â”‚ Managed Policy ARN                                                             â”‚
    â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ + â”‚ ${HelloHandler/ServiceRole} â”‚ arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole â”‚
    â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

    Parameters
    [+] Parameter AssetParameters/3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7/S3Bucket AssetParameters3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7S3BucketEB5CA0D6: {"Type":"String","Description":"S3 bucket for asset \"3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7\""}
    [+] Parameter AssetParameters/3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7/S3VersionKey AssetParameters3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7S3VersionKeyC5F120D1: {"Type":"String","Description":"S3 key for asset version \"3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7\""}
    [+] Parameter AssetParameters/3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7/ArtifactHash AssetParameters3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7ArtifactHashBAACCCD2: {"Type":"String","Description":"Artifact hash for asset \"3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7\""}

    Resources
    [+] AWS::IAM::Role HelloHandler/ServiceRole HelloHandlerServiceRole11EF7C63
    [+] AWS::Lambda::Function HelloHandler HelloHandler2E4FBA4D

    â–  ãƒ‡ãƒ—ãƒ­ã‚¤(cdk deploy)

    â–  Lambda ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§é–¢æ•°ãƒ†ã‚¹ãƒˆ

    â€¢ Lambda > Functions > HelloHandler > ãƒ†ã‚¹ãƒˆ ã§ãƒ†ã‚¹ãƒˆä½œæˆ
    â€¢ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ãƒªã‚¹ãƒˆ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰ API Gateway AWS Proxy é¸æŠ
    â€¢ ã‚¤ãƒ™ãƒ³ãƒˆå: test
    â€¢ ãƒ†ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¦å®Ÿè¡Œã‚¯ãƒªãƒƒã‚¯
    â€¢ å®Ÿè¡Œä¸­ã®é–¢æ•° ãƒšã‚¤ãƒ³ã® è©³ç´° ã‚’å±•é–‹ã—ã¦å‡ºåŠ›ã‚’è¡¨ç¤º
      {
        "statusCode": 200,
        "headers": {
          "Content-Type": "text/plain"
        },
        "body": "Hello, CDK! You've hit /hello\n"
      }

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 10.ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ—ãƒ­ã‚¤(é–‹ç™ºç”¨)
  BODY: |
    â–  é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤

    â€¢ é€šå¸¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ™‚é–“ãŒã‹ã‹ã‚‹(24ï½27ç§’)

    â–  ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ—ãƒ­ã‚¤

    â€¢ ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ—ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã€å¤‰æ›´ã•ã‚ŒãŸ Lambda é–¢æ•°ã®ã‚³ãƒ¼ãƒ‰ã‚’ã€Œé«˜é€Ÿ(3~4ç§’)ã€ã«æ›´æ–°ã™ã‚‹ãŸã‚ã«ä½¿ç”¨
    â€¢ ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã«ã®ã¿å¯¾å¿œã—ã€ãƒªã‚½ãƒ¼ã‚¹ã®è¿½åŠ ã‚„å‰Šé™¤ã«ã¯é€šå¸¸ãƒ‡ãƒ—ãƒ­ã‚¤

    > cdk deploy --hotswap

    CdkWorkshopStack: deploying...
    CdkWorkshopStack: hotswapping CloudFormation changeset...

    âœ…  CdkWorkshopStack

    Stack ARN:
    arn:aws:cloudformation:ap-northeast-1:123456789012:stack/CdkWorkshopStack/{STACK-ID}

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 11.CDK Watch
  BODY: |
    â–  cdk watch

    â€¢ cdk deploy ã‚„ cdk deploy --hotswap ã‚’æ¯å›å‘¼ã³å‡ºã™ã®ã¯å†—é•·
    â€¢ cdk watch ã¯ã‚³ãƒ¼ãƒ‰ã¨ã‚¢ã‚»ãƒƒãƒˆã®å¤‰æ›´ã‚’ç›£è¦–ã€å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
    â€¢ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€cdk watch ã¯ --hotswap ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã€ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ—ã§ãã‚‹ã‹è‡ªå‹•åˆ¤æ–­
    â€¢ cdk watch --no-hotswap ã¨å‘¼ã³å‡ºã™ã¨ã€ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ—å‹•ä½œãŒç„¡åŠ¹
    â€¢ ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ—å¯èƒ½ãªå¤‰æ›´ã€å®Œå…¨ãª CloudFormation ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å¿…è¦ã¨ã™ã‚‹å¤‰æ›´ã®ä¸¡æ–¹ã‚’æ¤œå‡º

    â–  ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£
    â€¢ ç›£è¦–ãƒ•ã‚¡ã‚¤ãƒ«ã¯ cdk.json ãƒ•ã‚¡ã‚¤ãƒ«ã® "watch" è¨­å®šã§æ±ºå®š
    â€¢ "watch" ã«ã¯ "include","exclude" ã®ãƒ•ã‚¡ã‚¤ãƒ«å/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã®æ–‡å­—åˆ—/æ–‡å­—åˆ—ã®é…åˆ—ãŒã‚ã‚‹
    â€¢ cdk.json åŸºæº–ã«ã—ãŸç›¸å¯¾ãƒ‘ã‚¹
    â€¢ ã€Œ*ã€ã¨ã€Œ**ã€ã®ä¸¡æ–¹ã® glob ãŒä½¿ç”¨å¯èƒ½

      {
        "app": "npx ts-node --prefer-ts-exts bin/cdk-workshop.ts",
        "watch": {
          "include": ["**"],     // ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›£è¦–
          "exclude": [           // é™¤å¤–ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
            "README.md",
            "cdk*.json",
            "**/*.d.ts",
            // "**/*.js",         // .js ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã‹ã‚‰å‰Šé™¤
            "tsconfig.json",
            "package*.json",
            "yarn.lock",
            "node_modules",
            "test"
          ]
        },
        "context": {
          // ...
        }
      }

    â–  cdk watch ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

    > cdk watch

    â€¢ æœ€åˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã€cdk.json æŒ‡å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ç›£è¦–ãŒé–‹å§‹

    â–  å¤‰æ›´ãƒ†ã‚¹ãƒˆ

    â€¢ lambda/hello.js ã® lambda ã‚¢ã‚»ãƒƒãƒˆã‚³ãƒ¼ãƒ‰å¤‰æ›´

    exports.handler = async function (event) {
      console.log('request:', JSON.stringify(event, undefined, 2))
      return {
        statusCode: 200,
        headers: { 'Content-Type': 'text/plain' },
        body: `Good Night, CDK! You've hit ${event.path}\n`,
      }
    }

    â€¢ Lambda ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å¤‰æ›´ä¿å­˜ã§ã€cdk watch ã¯æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼
    â€¢ ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ—èªè­˜ã®ãŸã‚ã€CloudFormation ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒã‚¤ãƒ‘ã‚¹ã€Lambda ã‚µãƒ¼ãƒ“ã‚¹ã«ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤

      Detected change to 'lambda/hello.js' (type: change). Triggering 'cdk deploy'

      âœ¨  Synthesis time: 2.34s

      âš ï¸ The --hotswap flag deliberately introduces CloudFormation drift to speed up deployments
      âš ï¸ It should only be used for development - never use it for your production Stacks!

      CdkWorkshopStack: deploying...
      âœ¨ hotswapping resources:
        âœ¨ Lambda Function 'CdkWorkshopStack-HelloHandler2E4FBA4D-tEZTcXqG8YYe'
      âœ¨ Lambda Function 'CdkWorkshopStack-HelloHandler2E4FBA4D-tEZTcXqG8YYe' hotswapped!

      âœ…  CdkWorkshopStack

      âœ¨  Deployment time: 3.93s

      Stack ARN:
      arn:aws:cloudformation:REGION:ACCOUNT-ID:stack/CdkWorkshopStack/STACK-ID

      âœ¨  Total time: 6.28s

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(Hello): 12.API Gateway è¿½åŠ 
  BODY: |
    â–  API Gateway è¿½åŠ 

    â€¢ API Gateway ã‚’ä½¿ç”¨ã—ã¦ã€Lambda é–¢æ•°ã‚’ HTTP ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦å…¬é–‹
    â€¢ API ã®ãƒ«ãƒ¼ãƒˆã«ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸ Lambda ãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ç”¨
      â€¢ ä»»æ„ã® URL ãƒ‘ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç›´æ¥ Lambda é–¢æ•°ã«ãƒ—ãƒ­ã‚­ã‚·ã•ã‚Œã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´

    â–  ã‚¹ã‚¿ãƒƒã‚¯ã« LambdaRestApi ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆè¿½åŠ 

    â€¢ lib/cdk-workshop-stack.ts ã« API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®šç¾©ã€Lambda é–¢æ•°ã¨é–¢é€£ä»˜ã‘

    import { Stack, StackProps } from "aws-cdk-lib";
    import { Code, Function, Runtime } from "aws-cdk-lib/aws-lambda";
    import { Construct } from "constructs";
    import { LambdaRestApi } from "aws-cdk-lib/aws-apigateway";   // <---- API Gateway ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

    export class CdkWorkshopStack extends Stack {
      constructor(scope: Construct, id: string, props?: StackProps) {
        super(scope, id, props);

        const hello = new Function(this, "HelloHandler", {
          runtime: Runtime.NODEJS_22_X,
          code: Code.fromAsset("lambda"),
          handler: "hello.handler",
        });

        // ã€Œhelloã€é–¢æ•°ã‚’åŸºç›¤ã¨ã—ãŸAPI Gateway REST APIãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©
        const gateway = new LambdaRestApi(this, "Endpoint", {
          handler: hello,
        });
      }
    }

    â–  å·®åˆ†ç¢ºèª

    > cdk diff

      Stack CdkWorkshopStack
      IAM Statement Changes
      â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   â”‚ Resource                  â”‚ Effect â”‚ Action                    â”‚ Principal                 â”‚ Condition                   â”‚
      â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ + â”‚ ${Endpoint/CloudWatchRole â”‚ Allow  â”‚ sts:AssumeRole            â”‚ Service:apigateway.${AWS: â”‚                             â”‚
      â”‚   â”‚ .Arn}                     â”‚        â”‚                           â”‚ :URLSuffix}               â”‚                             â”‚
      â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ + â”‚ ${HelloHandler.Arn}       â”‚ Allow  â”‚ lambda:InvokeFunction     â”‚ Service:apigateway.amazon â”‚ "ArnLike": {                â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚ aws.com                   â”‚   "AWS:SourceArn": "arn:${A â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ WS::Partition}:execute-api: â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ ${AWS::Region}:${AWS::Accou â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ ntId}:${EndpointEEF1FD8F}/$ â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ {Endpoint/DeploymentStage.p â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ rod}/*/"                    â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ }                           â”‚
      â”‚ + â”‚ ${HelloHandler.Arn}       â”‚ Allow  â”‚ lambda:InvokeFunction     â”‚ Service:apigateway.amazon â”‚ "ArnLike": {                â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚ aws.com                   â”‚   "AWS:SourceArn": "arn:${A â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ WS::Partition}:execute-api: â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ ${AWS::Region}:${AWS::Accou â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ ntId}:${EndpointEEF1FD8F}/t â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ est-invoke-stage/*/"        â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ }                           â”‚
      â”‚ + â”‚ ${HelloHandler.Arn}       â”‚ Allow  â”‚ lambda:InvokeFunction     â”‚ Service:apigateway.amazon â”‚ "ArnLike": {                â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚ aws.com                   â”‚   "AWS:SourceArn": "arn:${A â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ WS::Partition}:execute-api: â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ ${AWS::Region}:${AWS::Accou â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ ntId}:${EndpointEEF1FD8F}/$ â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ {Endpoint/DeploymentStage.p â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ rod}/*/{proxy+}"            â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ }                           â”‚
      â”‚ + â”‚ ${HelloHandler.Arn}       â”‚ Allow  â”‚ lambda:InvokeFunction     â”‚ Service:apigateway.amazon â”‚ "ArnLike": {                â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚ aws.com                   â”‚   "AWS:SourceArn": "arn:${A â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ WS::Partition}:execute-api: â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ ${AWS::Region}:${AWS::Accou â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ ntId}:${EndpointEEF1FD8F}/t â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ est-invoke-stage/*/{proxy+} â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ "                           â”‚
      â”‚   â”‚                           â”‚        â”‚                           â”‚                           â”‚ }                           â”‚
      â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      IAM Policy Changes
      â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   â”‚ Resource                   â”‚ Managed Policy ARN                                                                      â”‚
      â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ + â”‚ ${Endpoint/CloudWatchRole} â”‚ arn:${AWS::Partition}:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs â”‚
      â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      (NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

      Resources
      [+] AWS::ApiGateway::RestApi    Endpoint EndpointEEF1FD8F
      [+] AWS::ApiGateway::Deployment Endpoint/Deployment EndpointDeployment...
      [+] AWS::ApiGateway::Stage      Endpoint/DeploymentStage.prod EndpointDeploymentStageprod...
      [+] AWS::IAM       ::Role       Endpoint/CloudWatchRole EndpointCloudWatchRole...
      [+] AWS::ApiGateway::Account    Endpoint/Account EndpointAccount...
      [+] AWS::ApiGateway::Resource   Endpoint/Default/{proxy+} Endpointproxy...
      [+] AWS::Lambda    ::Permission Endpoint/Default/{proxy+}/ANY/ApiPermission.CdkWorkshopStackEndpoint018E8349.ANY..{proxy+} EndpointproxyANYApiPermissionCdkWorkshopStackEndpoint...
      [+] AWS::Lambda    ::Permission Endpoint/Default/{proxy+}/ANY/ApiPermission.Test.CdkWorkshopStackEndpoint018E8349.ANY..{proxy+} EndpointproxyANYApiPermissionTestCdkWorkshopStackEndpoint...
      [+] AWS::ApiGateway::Method     Endpoint/Default/{proxy+}/ANY EndpointproxyANYC09721C5
      [+] AWS::Lambda    ::Permission Endpoint/Default/ANY/ApiPermission.CdkWorkshopStackEndpoint018E8349.ANY.. EndpointANYApiPermissionCdkWorkshopStackEndpoint...
      [+] AWS::Lambda    ::Permission Endpoint/Default/ANY/ApiPermission.Test.CdkWorkshopStackEndpoint018E8349.ANY.. EndpointANYApiPermissionTestCdkWorkshopStackEndpoint...
      [+] AWS::ApiGateway::Method     Endpoint/Default/ANY EndpointANY485C938B

      Outputs
      [+] Output Endpoint/Endpoint Endpoint8024A810:
      {"Value":{"Fn::Join":["",["https://",{"Ref":"EndpointEEF1FD8F"},".execute-api.",{"Ref":"AWS::Region"},".",{"Ref":"AWS::URLSuffix"},"/",{"Ref":"EndpointDeploymentStageprod..."},"/"]]}}

    â–  ãƒ‡ãƒ—ãƒ­ã‚¤

    > cdk deploy


    â–  ã‚¹ã‚¿ãƒƒã‚¯å‡ºåŠ›

    â€¢ API Gateway ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ URL è¡¨ç¤º

    CdkWorkshopStack.Endpoint8024A810 = https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/

    â–  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ

    curl https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/

    Hello, CDK! You've hit /

    â–  å‹•ä½œã—ãªã‹ã£ãŸå ´åˆã¯?

    â€¢ API Gateway ã‹ã‚‰ 5xx ã‚¨ãƒ©ãƒ¼
      â€¢ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ API Gateway ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã§ã¯ãªã„
        â€¢ ãƒãƒ³ãƒ‰ãƒ©ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ statusCodeã€bodyã€header ã‚’å«ã‚€ã“ã¨ã‚’ç¢ºèª
      â€¢ ä½•ã‚‰ã‹ã®ç†ç”±ã§é–¢æ•°ãŒå¤±æ•—
        â€¢ Lambda ãƒ­ã‚°ã®è¡¨ç¤ºã‚’ç¢ºèª

- ENTRY:
  CATEGORY: |
    workshop: HitCounter

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(HitCounter): 1.ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆ
  BODY: |
    â–  HitCounter ã¨ã„ã†æ–°ã—ã„ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆå®šç¾©

    â€¢ API Gateway ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã‚‹ Lambda é–¢æ•°ã«ã‚¢ã‚¿ãƒƒãƒ
    â€¢ å„ URL ãƒ‘ã‚¹ã«å¯¾ã—ã¦ç™ºè¡Œã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    â€¢ çµæœã‚’ DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜

    â–  hitcounter.ts (ã¾ãšã¯ç®±ã®ã¿ä½œæˆ)
    import { IFunction } from "aws-cdk-lib/aws-lambda";
    import { Construct } from "constructs";

    export interface HitCounterProps {
      // URLãƒ’ãƒƒãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹é–¢æ•°
      downstream: IFunction;
    }

    export class HitCounter extends Construct {
      constructor(scope: Construct, id: string, props: HitCounterProps) {
        super(scope, id);
        // TODO (ã“ã“ã« DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ Lambda é–¢æ•°ã‚’å®šç¾©)
      }
    }

    â–  lambda/hitcounter.js
    const { DynamoDB } = require("@aws-sdk/client-dynamodb");
    const { Lambda, InvokeCommand } = require("@aws-sdk/client-lambda");

    exports.handler = async function (event) {
      console.log("request:", JSON.stringify(event, undefined, 2));

      const dynamo = new DynamoDB();
      const lambda = new Lambda();

      // hits++ã§ã€Œpathã€ã®DynamoDBã‚¨ãƒ³ãƒˆãƒªã‚’æ›´æ–°
      await dynamo.updateItem({
        TableName:                 process.env.HITS_TABLE_NAME, // DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«å
        Key:                       { path: { S: event.path } },
        UpdateExpression:          "ADD hits :incr",
        ExpressionAttributeValues: { ":incr": { N: "1" } },
      });

      // ä¸‹æµé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹
      const command = new InvokeCommand({
        FunctionName: process.env.DOWNSTREAM_FUNCTION_NAME,  // ãƒ€ã‚¦ãƒ³ã‚¹ãƒˆãƒªãƒ¼ãƒ ã® Lambda é–¢å
        Payload: JSON.stringify(event),
      });
      const { Payload } = await lambda.send(command);
      const result = Buffer.from(Payload).toString();
      console.log("downstream response:", JSON.stringify(result, undefined, 2));
      return JSON.parse(result);        // æˆ»ã‚Šå€¤ã‚’upstreamã«è¿”ã™
    };

    â–  hitcounter.ts(ç®±ã®ä¸­èº«å®Ÿè£…)

    â€¢ path ã‚’ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã¨ã™ã‚‹ DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®šç¾©
    â€¢ lambda/hitcounter.handler ã‚³ãƒ¼ãƒ‰ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸ Lambda é–¢æ•°ã‚’å®šç¾©
    â€¢ Lambda ã®ç’°å¢ƒå¤‰æ•°ã‚’ãƒªã‚½ãƒ¼ã‚¹ã® functionName ã¨ tableName ã«ç´ä»˜ã‘

    â€¢ functionName ã¨ tableName ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã¨ãã«ã®ã¿è§£æ±ºã•ã‚Œã‚‹å€¤
      â€¢ æ³¨æ„: ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„é–¢æ•°ã‚’å®šç¾©æ™‚ã€ã“ã‚Œã‚‰ã®ç‰©ç†åã‚’è¨­å®šã—ã¦ã„ãªã„
        â€¢ è«–ç† ID ã®ã¿è¨­å®š
      â€¢ åˆæˆä¸­ã«ã“ã‚Œã‚‰ã®å€¤ã‚’å‡ºåŠ›ã™ã‚‹ã¨ã€CDK ãŒã“ã‚Œã‚‰ã®é…å»¶ãƒã‚¤ãƒ³ãƒ‰å€¤ã‚’è¡¨ã™ãŸã‚ã® TOKEN ãŒå¾—ã‚‰ã‚Œã‚‹
        â€¢ ã“ã‚Œã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ æœªçŸ¥ã®æ–‡å­—åˆ— ã¨ã—ã¦æ‰±ã†å¿…è¦ãŒã‚ã‚‹
        â€¢ é€£çµã¯å¯èƒ½ã§ã™ãŒã€ã‚³ãƒ¼ãƒ‰å†…ã§è§£æã—ã‚ˆã†ã¨ã—ã¦ã¯ã„ã‘ãªã„

    import { AttributeType, Table } from "aws-cdk-lib/aws-dynamodb";
    import { Code, Function, IFunction, Runtime } from "aws-cdk-lib/aws-lambda";
    import { Construct } from "constructs";

    export interface HitCounterProps {
      // URLãƒ’ãƒƒãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹é–¢æ•°
      downstream: IFunction;
    }

    export class HitCounter extends Construct {
      // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ©Ÿèƒ½ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯
      public readonly handler: Function;

      constructor(scope: Construct, id: string, props: HitCounterProps) {
        super(scope, id);

        const table = new Table(this, "Hits", {
          partitionKey: { name: "path", type: AttributeType.STRING },
        });

        this.handler = new Function(this, "HitCounterHandler", {
          runtime: Runtime.NODEJS_22_X,
          handler: "hitcounter.handler",
          code: Code.fromAsset("lambda"),
          environment: {
            DOWNSTREAM_FUNCTION_NAME: props.downstream.functionName,
            HITS_TABLE_NAME: table.tableName,
          },
        });
      }
    }

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(HitCounter): 2.ã‚¹ã‚¿ãƒƒã‚¯ã«ãƒ’ãƒƒãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’è¿½åŠ 
  BODY: |
    â–  ã‚¹ã‚¿ãƒƒã‚¯ã«ãƒ’ãƒƒãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¿½åŠ 
    import { Stack, StackProps } from "aws-cdk-lib";
    import { Code, Function, Runtime } from "aws-cdk-lib/aws-lambda";
    import { Construct } from "constructs";
    import { LambdaRestApi } from "aws-cdk-lib/aws-apigateway";
    import { HitCounter } from "./hitcounter";

    export class CdkWorkshopStack extends Stack {
      constructor(scope: Construct, id: string, props?: StackProps) {
        super(scope, id, props);

        // AWS Lambdaãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©
        const hello = new Function(this, "HelloHandler", {
          runtime: Runtime.NODEJS_22_X,         // å®Ÿè¡Œç’°å¢ƒ(Nodejs v22.x)
          code:    Code.fromAsset("lambda"),    // /lambda æŒ‡å®š(cdkã‚’å®Ÿè¡Œã™ã‚‹å ´æ‰€ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹)
          handler: "hello.handler",             // ãƒ•ã‚¡ã‚¤ãƒ«å: hello, ãƒ¡ã‚½ãƒƒãƒ‰: handler
        });

        const helloWithCounter = new HitCounter(this, "HelloHitCounter", {
          downstream: hello,
        });

        // ã€Œhelloã€é–¢æ•°ã‚’åŸºã«ã—ãŸ API Gateway REST API ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©
        const gateway = new LambdaRestApi(this, "Endpoint", {
          handler: helloWithCounter.handler,   // <--- API Gateway ãƒãƒ³ãƒ‰ãƒ©ã‚’ helloWithCounter.handler ã«å¤‰æ›´
        });
      }
    }

      ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãƒ’ãƒƒãƒˆ
      -> API Gateway ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ ãƒ’ãƒƒãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒãƒ³ãƒ‰ãƒ© ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
      -> ãƒ’ãƒƒãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãŒãƒ’ãƒƒãƒˆã‚’è¨˜éŒ²ã—ã¦ hello é–¢æ•°ã«ãƒªãƒ¬ãƒ¼
      -> ãã®å¾Œã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé€†é †ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ã§ãƒªãƒ¬ãƒ¼

    â–  ãƒ‡ãƒ—ãƒ­ã‚¤
      > cdk deploy

      CdkWorkshopStack.Endpoint8024A810 = https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/

    â–  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ
    curl https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/

    HTTP/2 502 Bad Gateway
    ...
    {"message": "Internal server error"}

    â–  CloudWatch Logs ã§ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’æ¢ã‚‹
    â€¢ AWS Lambda ã‚³ãƒ³ã‚½ãƒ¼ãƒ«
    â€¢ HitCounter é–¢æ•°(CdkWorkshopStack-HelloHitCounter ã¨ã„ã†æ–‡å­—åˆ—ã‚’å«ã‚€)ã‚’ã‚¯ãƒªãƒƒã‚¯
    â€¢ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
    â€¢ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° ã‚¿ãƒ–ã®ä¸‹éƒ¨ã«ã‚ã‚‹ CloudWatch ãƒ­ã‚°ã‚’è¡¨ç¤º ã‚’ã‚¯ãƒªãƒƒã‚¯
      â€¢ AWS CloudWatch ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãŒé–‹ã
    â€¢ æœ€æ–°ã®ãƒ­ã‚°ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ
    â€¢ ã€ŒerrorMessageã€ã‚’å«ã‚€æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™
      {
        "errorMessage": "User: arn:aws:sts::123456789012:assumed-role/CdkWorkshopStack-HelloHitCounterHitCounterHandlerS-TU5M09L1UBID/
          CdkWorkshopStack-HelloHitCounterHitCounterHandlerD-144HVUNEWRWEO is not authorized to perform: dynamodb:UpdateItem on resource: 
          arn:aws:dynamodb:us-east-1:123456789012:table/CdkWorkshopStack-HelloHitCounterHits7AAEBF80-1DZVT3W84LJKB",
        "errorType": "AccessDeniedException",
        "stackTrace": [
          "Request.extractError (/var/runtime/node_modules/aws-sdk/lib/protocol/json.js:48:27)",
          "Request.callListeners (/var/runtime/node_modules/aws-sdk/lib/sequential_executor.js:105:20)",
          ...
          ]
      }

      â€» "is not authorized!" ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã‚‹ã®ã‚’ç¢ºèª
         Lambda é–¢æ•°ãŒ DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ›¸ãè¾¼ã‚ãªã„ -> ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ä»˜ä¸ã—ã¦ã„ãªã„

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(HitCounter): 3.ä¿®æ­£
  BODY: |
    â–  DynamoDBã‚¢ã‚¯ã‚»ã‚¹è¨±å¯è¿½åŠ 
    import { AttributeType, Table } from "aws-cdk-lib/aws-dynamodb";
    import { Code, Function, IFunction, Runtime } from "aws-cdk-lib/aws-lambda";
    import { Construct } from "constructs";

    export interface HitCounterProps {
      downstream: IFunction;
    }

    export class HitCounter extends Construct {
      public readonly handler: Function;

      constructor(scope: Construct, id: string, props: HitCounterProps) {
        super(scope, id);

        const table = new Table(this, "Hits", {
          partitionKey: { name: "path", type: AttributeType.STRING },
        });

        this.handler = new Function(this, "HitCounterHandler", {
          runtime: Runtime.NODEJS_22_X,
          handler: "hitcounter.handler",
          code: Code.fromAsset("lambda"),
          environment: {
            DOWNSTREAM_FUNCTION_NAME: props.downstream.functionName,
            HITS_TABLE_NAME: table.tableName,
          },
        });

        // ğŸ”µLambdaãƒ­ãƒ¼ãƒ«ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®èª­ã¿å–ã‚Š/æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
        table.grantReadWriteData(this.handler);

        // ğŸ”µLambdaãƒ­ãƒ¼ãƒ«ã«ä¸‹æµé–¢æ•°(downstream)ã¸ã®å‘¼ã³å‡ºã—æ¨©é™ã‚’ä»˜ä¸
        props.downstream.grantInvoke(this.handler);
      }
    }

    â–  Diff(å¤‰æ›´ç®‡æ‰€ã®ç¢ºèª)
    > cdk diff

    â–  Resource ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    ãƒ­ãƒ¼ãƒ«ã¸ã® IAM ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆè¿½åŠ 

    Resources
    [~] AWS::IAM::Policy HelloHitCounter/HitCounterHandler/ServiceRole/DefaultPolicy HelloHitCounterHitCounterHandlerServiceRoleDefaultPolicy1487A60A
    â””â”€ [~] PolicyDocument
        â””â”€ [~] .Statement:
            â””â”€ @@ -19,5 +19,15 @@
                [ ]         "Arn"
                [ ]       ]
                [ ]     }
                [+]   },
                [+]   {
                [+]     "Action": "lambda:InvokeFunction",
                [+]     "Effect": "Allow",
                [+]     "Resource": {
                [+]       "Fn::GetAtt": [
                [+]         "HelloHandler2E4FBA4D",
                [+]         "Arn"
                [+]       ]
                [+]     }
                [ ]   }
                [ ] ]

    â–  ãƒ‡ãƒ—ãƒ­ã‚¤
      > cdk deploy

    â–  ãƒ†ã‚¹ãƒˆ(ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹)
      curl -i https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/
      :::{showCopyAction=true showLineNumbers=false language=typescript}

    â€¢ å‡ºåŠ›

      :::code{showLineNumbers=false language=shell}
      HTTP/2 200 OK
      ...
      Hello, CDK! You've hit /

    â€¢ 5xx ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€æ•°ç§’å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
      â€¢ API Gateway ãŒæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã€Œåˆ‡ã‚Šæ›¿ãˆã‚‹ã€ã®ã«å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹

- ENTRY:
  EXPLAIN: |
    ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—(HitCounter): 4.ãƒ†ã‚¹ãƒˆ
  BODY: |
    â–  ãƒ’ãƒƒãƒˆã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆ
    â€¢ ãƒ†ã‚¹ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆç™ºè¡Œ
      curl https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/
      curl https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/
      curl https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/hello
      curl https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/hello/world
      curl https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/prod/hello/world

    â€¢ DynamoDB ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèª
      â€¢ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒšã‚¤ãƒ³ã§ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚’é¸æŠ
      â€¢ CdkWorkdShopStack-HelloHitCounterHits ã§å§‹ã¾ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ
      â€¢ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–‹ãã€ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã®æ¢ç´¢ã€ã‚’é¸æŠ
      â€¢ å„ãƒ‘ã‚¹ã®ãƒ’ãƒƒãƒˆæ•°ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
